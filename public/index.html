<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <title>UMGKL HUB</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="program_icons/oldal_logo.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Condensed:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="HOI4-Porgonc/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
      :root {
        --bg-primary: #36393f; /* Discord dark gray */
        --bg-secondary: #2f3136; /* Slightly darker for header */
        --text-primary: #dcddde; /* Light gray text */
        --accent: #7289da; /* Discord blurple */
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        padding: 0; /* Remove outer spacing so header and footer reach page edges */
      }

      header {
        background: var(--bg-secondary);
        padding-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        width: 100%;
      }

      .banner {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        display: block;
      }

      h1 {
        margin-top: 1rem;
        font-size: 2.5rem;
        color: var(--accent);
      }

      nav {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
        border-top: 1px solid #202225;
        border-bottom: 1px solid #202225;
        padding: 0.5rem 0;
      }

      nav a {
        color: var(--text-primary);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: background 0.2s;
      }

      nav a:hover,
      nav a.active {
        background: var(--accent);
        color: #fff;
      }

      main {
        flex: 1;
        padding: 2rem;
      }

      section {
        display: none;
        max-width: 800px;
        margin: 0 auto;
        text-align: left;
        line-height: 1.6;
      }

      section.active {
        display: block;
      }

      .hero {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        text-align: center;
        padding: 3rem 2rem;
        background: linear-gradient(145deg, rgba(47, 49, 54, 0.85), rgba(54, 57, 63, 0.8));
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
      }

      .hero__title {
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 700;
        color: #fff;
        letter-spacing: 0.03em;
      }

      .hero__description {
        font-size: 1.1rem;
        color: #b9bbbe;
        max-width: 640px;
      }

      .hero__actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
        width: 100%;
      }

      .hero__button {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.85rem 2.5rem;
        font-size: 1.05rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(114, 137, 218, 0.35);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .hero__button:hover,
      .hero__button:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 14px 32px rgba(114, 137, 218, 0.45);
        outline: none;
      }

      .summary-card {
        display: none;
        background: rgba(32, 34, 37, 0.95);
        border-radius: 14px;
        padding: 2rem;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(255, 255, 255, 0.05);
        max-width: 900px;
        width: min(100%, 900px);
        text-align: left;
        line-height: 1.7;
        gap: 1.5rem;
      }

      .summary-card.summary-card--visible {
        display: flex;
        flex-direction: column;
        animation: fadeInUp 0.25s ease forwards;
      }

      .summary-card__body {
        max-height: 340px;
        overflow-y: auto;
        padding-right: 0.5rem;
        color: #e3e5e8;
      }

      .summary-card__close {
        align-self: center;
        background: #3a3d42;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: 0.75rem 2rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .summary-card__close:hover,
      .summary-card__close:focus-visible {
        background: #484b51;
        transform: translateY(-1px);
        outline: none;
      }

      .is-hidden {
        display: none !important;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      #video-grid-container {
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .video-card {
        background: #2c2f33;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .video-card video {
        width: 100%;
        border-radius: 6px;
        background: #000;
      }

      .video-card p {
        margin: 0;
        font-weight: 500;
      }

      /* A HOI4 sorsol√≥ szekci√≥n√°l ne legyen sz√©less√©gkorl√°t, hogy a n√©gy doboz egym√°s mellett
         maradjon */
      #sorsolas {
        max-width: none;
      }

      /* Szavaz√°s st√≠lusok */
      #szavazas.active {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .poll-card {
        background: #2c2f33;
        padding: 1rem;
        border: 1px solid #202225;
        border-radius: 6px;
      }

      .poll-card h3 {
        margin-top: 0;
        margin-bottom: 0.75rem;
      }

      .poll-hint {
        color: #b9bbbe;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
      }

      .poll-text-input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        background: #1e2124;
        border: 1px solid #202225;
        border-radius: 4px;
      }

      .poll-options-inputs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .poll-option-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .poll-option-input {
        flex: 1;
        padding: 0.75rem;
        color: var(--text-primary);
        background: #1e2124;
        border: 1px solid #202225;
        border-radius: 4px;
        font-size: 1rem;
      }

      .poll-option-remove {
        width: auto; /* Fel√ºl√≠rja a glob√°lis 100%-os sz√©less√©get */
        background: #202225;
        border: none;
        color: #fff;
        border-radius: 4px;
        padding: 0.25rem 0.5rem; /* Vissza√°ll√≠tva az eredetire a kisebb m√©ret√©rt */
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
      }

      .poll-option-remove:hover:not(:disabled) {
        background: #f04747;
      }

      .poll-option-remove:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .poll-creator-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
      }

      .poll-button {
        background: var(--accent);
        border: none;
        padding: 0.5rem 1rem;
        color: #fff;
        cursor: pointer;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        font-weight: 600;
      }

      .poll-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .poll-secondary-btn {
        background: #3a3d42;
      }

      .poll-secondary-btn:hover:not(:disabled) {
        background: #484b51;
      }

      .poll-primary-btn:hover:not(:disabled),
      .poll-vote-btn:hover:not(:disabled) {
        filter: brightness(1.05);
      }

      .poll-close-btn {
        background: #f04747;
      }

      .poll-close-btn:hover:not(:disabled) {
        background: #ff5c5c;
      }

      .poll-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .poll-card-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .poll-status {
        background: #1e2124;
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #b9bbbe;
      }

      .poll-status--active {
        color: #57f287;
      }

      .poll-status--closed {
        color: #f04747;
      }

      .poll-meta {
        font-size: 0.85rem;
        color: #b9bbbe;
      }

      .poll-options-results {
        margin-top: 0.75rem;
      }

      .poll-option-result {
        padding: 0.75rem 0;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }

      .poll-option-result:first-of-type {
        border-top: none;
      }

      .poll-option-result--selected {
        border-left: 3px solid var(--accent);
        padding-left: 0.75rem;
        background: rgba(114, 137, 218, 0.08);
      }

      .poll-option-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .poll-option-label {
        flex: 1 1 auto;
        font-weight: 600;
      }

      .poll-option-count {
        font-size: 0.85rem;
        color: #b9bbbe;
      }

      .poll-badge {
        background: rgba(114, 137, 218, 0.2);
        color: var(--accent);
        border-radius: 999px;
        padding: 0.2rem 0.6rem;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .poll-result-bar {
        width: 100%;
        height: 0.75rem;
        background: #1e2124;
        border: 1px solid #202225;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 0.5rem;
      }

      .poll-result-bar-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), #5865f2);
        transition: width 0.3s ease;
      }

      .poll-option-result--selected .poll-result-bar-fill {
        background: linear-gradient(90deg, #57f287, var(--accent));
      }

      .poll-voters {
        margin-top: 0.4rem;
        font-size: 0.8rem;
        color: #b9bbbe;
      }

      .poll-total-votes {
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: #b9bbbe;
      }

      .poll-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .poll-empty {
        background: #2c2f33;
        padding: 1rem;
        border: 1px solid #202225;
        border-radius: 6px;
        text-align: center;
        color: #b9bbbe;
      }

        footer {
          width: 100%;
          padding: 1rem;
          font-size: 0.875rem;
          background: rgb(47, 49, 54);
        }
      /* Programok szekci√≥ st√≠lusai */
      #programok .program-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        justify-items: center;
      }

      #programok .box {
        width: 100%;
        max-width: 250px;
        text-align: center;
      }

      .program-icon {
        width: 120px;
        height: 120px;
        object-fit: contain;
        margin-bottom: 10px;
      }

      .download-btn {
        margin-top: 10px;
        padding: 0.5rem 1rem;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        cursor: not-allowed;
      }

      .user-table {
        width: 100%;
        max-width: 600px;
        margin-top: 1rem;
        border-collapse: collapse;
      }

      .user-table th,
      .user-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #4f545c;
      }

      .user-table input[type="number"] {
        width: 100%;
        max-width: 120px;
        padding: 0.4rem;
        border-radius: 4px;
        border: 1px solid #202225;
        background: #1e2124;
        color: var(--text-primary);
      }

      .user-table th {
        background-color: var(--bg-secondary);
      }

      .user-table tbody tr:hover {
        background-color: #3c4046;
      }

      .permission-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .admin-description {
        margin-top: 0.5rem;
        max-width: 600px;
      }

      #savePermissionsBtn {
        margin-top: 1.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }

      #savePermissionsBtn:hover:not(:disabled) {
        background: #5b6dad;
      }

      #savePermissionsBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Auth buttons */
      .auth-buttons {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .auth-buttons__group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .auth-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.6rem 1.4rem;
        margin-left: 0.25rem;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        min-width: 150px;
        font-weight: 600;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        padding: 1rem;
      }

      .upload-modal-content {
        background: var(--bg-secondary);
        padding: 1.5rem;
        border-radius: 8px;
        width: 100%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
      }

      .upload-modal-content h3 {
        margin-bottom: 1rem;
      }

      .close-btn {
        position: absolute;
        top: 0.75rem;
        right: 1rem;
        font-size: 1.5rem;
        cursor: pointer;
      }

      #drop-zone {
        border: 2px dashed var(--accent);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        background: rgba(114, 137, 218, 0.1);
        transition: background 0.2s, border-color 0.2s;
        margin-bottom: 1rem;
      }

      #drop-zone.drag-over {
        background: rgba(114, 137, 218, 0.2);
        border-color: #99a9e6;
      }

      #drop-zone p {
        margin-bottom: 0.5rem;
      }

      #uploadBtn {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        width: 100%;
      }

      #uploadBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .upload-status {
        margin-top: 0.75rem;
        min-height: 1.25rem;
      }

      /* Login modal */
      #loginModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1200;
      }

      #loginModal .modal-content {
        background: var(--bg-secondary);
        padding: 1rem;
        border-radius: 4px;
        width: 300px;
      }

      #loginModal input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border: 1px solid #202225;
        border-radius: 4px;
        background: #1e2124;
        color: var(--text-primary);
      }

      #loginModal button {
        width: 100%;
      }

      .feedback-modal {
        position: fixed;
        inset: 0;
        display: none;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1300;
        padding: 1rem;
      }

      .feedback-modal__content {
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 1.5rem;
        border-radius: 8px;
        width: min(90%, 360px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
        position: relative;
        text-align: center;
      }

      .feedback-modal__title {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
      }

      .feedback-modal__message {
        margin-bottom: 1.25rem;
      }

      .feedback-modal__close {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: transparent;
        border: none;
        color: inherit;
        font-size: 1.5rem;
        line-height: 1;
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 999px;
        transition: background 0.2s, color 0.2s;
      }

      .feedback-modal__close:hover,
      .feedback-modal__close:focus-visible {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        outline: none;
      }

      .feedback-modal__actions button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>UMGKL HUB</h1>
      <nav>
        <a href="#home" data-section="home" class="active">F≈ëoldal</a>
        <a href="#klipek" data-section="klipek">Klippek</a>
        <a href="#sorsolas" data-section="sorsolas">Hoi4 Sorsol√°s</a>
        <a href="#szavazas" data-section="szavazas">Szavaz√°s</a>
        <a
          href="#programok"
          data-section="programok"
          id="programNavBtn"
          data-requires-admin="true"
          style="display: none;"
          >Programok</a
        >
        <a
          href="#admin"
          data-section="admin"
          id="adminNavBtn"
          data-requires-admin="true"
          style="display: none;"
          >Admin M√≥d</a
        >
      </nav>
      <div class="auth-buttons">
        <div id="authLoggedOut" class="auth-buttons__group">
          <button id="loginBtn" type="button" class="auth-button">Bejelentkez√©s</button>
          <a href="register.html" id="registerBtn" class="auth-button">Regisztr√°ci√≥</a>
        </div>
        <div id="authLoggedIn" class="auth-buttons__group" style="display: none">
          <a href="#profile" id="userProfileLink" data-section="profile" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
            <img id="userAvatar" src="program_icons/default-avatar.png" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
            <span id="userGreeting"></span>
          </a>
          <button id="logoutBtn" type="button" class="auth-button">Kijelentkez√©s</button>
        </div>
      </div>
    </header>

    <div id="loginModal">
      <div class="modal-content">
        <span id="closeLogin" style="float: right; cursor: pointer">&times;</span>
        <h2>Bejelentkez√©s</h2>
        <form id="loginForm">
          <input type="text" id="loginUser" placeholder="Felhaszn√°l√≥n√©v" required />
          <input type="password" id="loginPass" placeholder="Jelsz√≥" required />
          <button type="submit">Bel√©p√©s</button>
        </form>
      </div>
    </div>

    <div id="feedbackModal" class="feedback-modal" role="dialog" aria-modal="true" aria-labelledby="feedbackModalTitle" style="display: none">
      <div class="feedback-modal__content">
        <button id="feedbackModalClose" class="feedback-modal__close" type="button" aria-label="Bez√°r√°s">&times;</button>
        <h3 id="feedbackModalTitle" class="feedback-modal__title"></h3>
        <p id="feedbackModalMessage" class="feedback-modal__message"></p>
        <div class="feedback-modal__actions">
          <button id="feedbackModalOk" type="button">OK</button>
        </div>
      </div>
    </div>

    <main>
      <!-- F≈ëoldal -->
      <section id="home" class="active">
        <div class="hero">
          <h2 class="hero__title">
            √údv√∂zl√ºnk az UMKGL Discord Szerver weboldal√°n!
          </h2>
          <p class="hero__description">
            Fedezd fel k√∂z√∂ss√©g√ºnk kedvenc pillanatait, programjait √©s esem√©nyeit egyetlen helyen.
          </p>
          <div class="hero__actions">
            <button id="summaryToggleBtn" type="button" class="hero__button" aria-expanded="false">
              R√∂vid √∂sszefoglal√≥
            </button>
            <article id="summaryCard" class="summary-card" aria-live="polite" aria-hidden="true">
              <div class="summary-card__body">
                <p>
                  A kezdetek, mintegy 13,8 milli√°rd √©vvel ezel≈ëtt, egy olyan szingularit√°sban gy√∂kereznek, ahol a t√©r, az id≈ë √©s az √°ltalunk ismert fizikai t√∂rv√©nyek m√©g nem l√©teztek. Ebb≈ël a v√©gtelen√ºl s≈±r≈± √©s forr√≥ √°llapotb√≥l indult ki az ≈êsrobban√°s n√©ven ismert kozmikus esem√©ny, amely elind√≠totta az univerzum m√°ig tart√≥ t√°gul√°s√°t. Az els≈ë n√©h√°ny pillanatban az elemi r√©szecsk√©k kaotikus t√°nc√°b√≥l megsz√ºlettek a protonok √©s neutronok, majd √©vsz√°zezredekkel k√©s≈ëbb az anyag annyira leh≈±lt, hogy az els≈ë atomok, a hidrog√©n √©s a h√©lium is √∂ssze√°llhattak. A gravit√°ci√≥ l√°thatatlan keze √°ltal vez√©relve ezen ≈ësi anyagfelh≈ëkb≈ël galaxisok, azokon bel√ºl pedig csillagok milli√°rdjai form√°l√≥dtak. E csillagkoh√≥k m√©ly√©n, nukle√°ris f√∫zi√≥ r√©v√©n j√∂ttek l√©tre a nehezebb elemek, amelyek k√©s≈ëbb sz√©tsz√≥r√≥dtak az ≈±rben, hogy √∫jabb csillagrendszerek √©s bolyg√≥k √©p√≠t≈ëk√∂veiv√© v√°ljanak.
                </p>
                <p>
                  Mintegy 4,6 milli√°rd √©vvel ezel≈ëtt, a Tej√∫trendszer egyik csendes karj√°ban egy ilyen kozmikus por- √©s g√°zfelh≈ëb≈ël alakult ki a mi Naprendszer√ºnk, √©s benne a F√∂ld bolyg√≥. A kezdetben izz√≥, olvadt k≈ëzetgoly√≥ felsz√≠ne fokozatosan h≈±lt le, lehet≈ëv√© t√©ve a v√≠z cseppfoly√≥s form√°ban val√≥ megjelen√©s√©t, ami alapvet≈ë felt√©tele volt az √©let kialakul√°s√°nak. Az ≈ësi "k√©miai levesben", prebiotikus monomerekb≈ël √©s aminosav-sz√°rmaz√©kokb√≥l √©vmilli√≥k sor√°n kialakultak az els≈ë √∂nreprodukci√≥ra k√©pes molekul√°ris rendszerek, val√≥sz√≠n≈±leg egy RNS-vil√°g form√°j√°ban. Ezen molekul√°ris egy√ºttesekb≈ël j√∂ttek l√©tre az els≈ë sejtes √©letform√°k, amelyek elind√≠tott√°k az evol√∫ci√≥ meg√°ll√≠thatatlan folyamat√°t. Ez a biol√≥giai diverzifik√°ci√≥ vezetett el v√©g√ºl a komplex, t√∂bbsejt≈± √©l≈ël√©nyek, majd az emberi faj, a Homo sapiens megjelen√©s√©hez.
                </p>
                <p>
                  Az emberi evol√∫ci√≥ kulcsfontoss√°g√∫ m√©rf√∂ldk√∂ve a tudat √©s az absztrakt gondolkod√°s kialakul√°sa volt, amely mag√°val hozta a kommunik√°ci√≥ ir√°nti elemi ig√©nyt. Kezdetben ez gesztusokra, mimik√°ra √©s egyszer≈± hangad√°sokra korl√°toz√≥dott, majd fokozatosan kifejl≈ëd√∂tt a tagolt besz√©d, amely lehet≈ëv√© tette a komplex inform√°ci√≥k √©s √∂tletek √°tad√°s√°t. A kommunik√°ci√≥ forradalmainak sor√°ban a k√∂vetkez≈ë l√©pcs≈ëfok az √≠r√°s megjelen√©se volt, amely el≈ësz√∂r tette lehet≈ëv√© az inform√°ci√≥ r√∂gz√≠t√©s√©t √©s id≈ëbeli, valamint t√©rbeli korl√°tok n√©lk√ºli tov√°bb√≠t√°s√°t. A k√∂nyvnyomtat√°s Gutenberg-f√©le forradalma tov√°bb demokratiz√°lta a tud√°shoz val√≥ hozz√°f√©r√©st, m√≠g az elektromoss√°g felfedez√©se elhozta a t√°v√≠r√≥, a telefon, majd a r√°di√≥ √©s a telev√≠zi√≥ kor√°t, radik√°lisan cs√∂kkentve a kommunik√°ci√≥s t√°vols√°gokat.
                </p>
                <p>
                  A 20. sz√°zad m√°sodik fel√©ben a digit√°lis forradalom √∫jabb paradigmav√°lt√°st hozott. A tranzisztor √©s az integr√°lt √°ramk√∂r√∂k feltal√°l√°sa elvezetett a sz√°m√≠t√≥g√©pek megjelen√©s√©hez. A hidegh√°bor√∫s katonai fejleszt√©sek mell√©kterm√©kek√©nt sz√ºletett meg az ARPANET, egy decentraliz√°lt, csomagkapcsolt h√°l√≥zat, amely a mai internet k√∂zvetlen ≈ës√©nek tekinthet≈ë. Ez a glob√°lis h√°l√≥zat eredetileg katonai √©s tudom√°nyos c√©lokat szolg√°lt, de az 1990-es √©vekt≈ël a World Wide Web megjelen√©s√©vel robban√°sszer≈±en terjedt el a civil felhaszn√°l√≥k k√∂r√©ben is. Megjelentek az els≈ë online k√∂z√∂ss√©gek, f√≥rumok √©s cseveg≈ëszob√°k, amelyek √∫j dimenzi√≥t nyitottak az emberi interakci√≥k sz√°m√°ra.
                </p>
                <p>
                  Az ezredfordul√≥t k√∂vet≈ëen, a videoj√°t√©kok √©s az online k√∂z√∂ss√©gek egyre szorosabb √∂sszefon√≥d√°sa egy specifikus ig√©nyt teremtett: egy olyan platformra volt sz√ºks√©g, amely z√∂kken≈ëmentes, alacsony k√©sleltet√©s≈± hang- √©s sz√∂veges kommunik√°ci√≥t tesz lehet≈ëv√© j√°t√©k k√∂zben, an√©lk√ºl, hogy jelent≈ësen terheln√© a rendszer er≈ëforr√°sait. Jason Citron √©s Stanislav Vishnevskiy programoz√≥k ezt az ig√©nyt felismerv√© hozt√°k l√©tre a Discordot, amely 2015-ben indult √∫tj√°ra. A platform, amely eredetileg a j√°t√©kosokat c√©lozta, hamar kin≈ëtte a r√©tegszerep√©t, √©s a COVID-19 vil√°gj√°rv√°ny idej√©n a legk√ºl√∂nf√©l√©bb √©rdekl≈ëd√©si k√∂r≈± k√∂z√∂ss√©gek (m≈±v√©szek, tanul√≥csoportok, bar√°ti t√°rsas√°gok) els≈ëdleges virtu√°lis tal√°lkoz√≥hely√©v√© v√°lt. A Discord szervereknek nevezett, testreszabhat√≥ k√∂z√∂ss√©gi tereket k√≠n√°l, ahol a felhaszn√°l√≥k sz√∂veges √©s hangcsatorn√°kon kereszt√ºl l√©phetnek kapcsolatba egym√°ssal.
                </p>
                <p>
                  √âs ezen a ponton, a kozmikus evol√∫ci√≥, a biol√≥giai fejl≈ëd√©s, valamint az emberi kommunik√°ci√≥ √©s technol√≥gia t√∂bb milli√°rd √©ves, sz√∂vev√©nyes √©s elker√ºlhetetlen folyamat√°nak logikus v√©gkifejletek√©nt, a digit√°lis t√©r egy meghat√°rozott koordin√°t√°j√°n, a megfelel≈ë csillag√°szati √©s technol√≥giai felt√©telek t√∂k√©letes egy√ºtt√°ll√°s√°nak pillanat√°ban, megsz√ºletett az a szikra, amely l√©trehozta a v√©gs≈ë k√∂z√∂ss√©gi manifeszt√°ci√≥t: az UMKGL Discord szervert.
                </p>
              </div>
              <button id="summaryCloseBtn" type="button" class="summary-card__close">
                √ñsszefoglal√≥ bez√°r√°sa
              </button>
            </article>
          </div>
        </div>
      </section>

      <section id="klipek">
        <h2>Leg√∫jabb Klipek</h2>
        <p>
          Hamarosan itt l√°thatod a k√∂z√∂ss√©g √°ltal felt√∂lt√∂tt legjobb
          klippeket!
        </p>
        <button id="showUploadModalBtn" style="float: right;">Felt√∂lt√©s</button>
        <div style="clear: both;"></div>
        <div id="video-grid-container">
          <!-- A vide√≥k dinamikusan ide fognak bet√∂lt≈ëdni a j√∂v≈ëben -->
        </div>
        <div id="uploadModal" class="modal-overlay" style="display: none;">
          <div class="upload-modal-content">
            <span class="close-btn" id="closeUploadModal">&times;</span>
            <h3>Vide√≥ felt√∂lt√©se</h3>
            <div id="drop-zone">
              <p>H√∫zd ide a vide√≥dat vagy kattints a tall√≥z√°shoz</p>
              <p id="selectedFileName">Nincs kiv√°lasztott f√°jl.</p>
            </div>
            <input type="file" id="fileInput" accept="video/*" style="display: none;" />
            <button id="uploadBtn" disabled>Felt√∂lt√©s</button>
            <p id="uploadStatus" class="upload-status"></p>
          </div>
        </div>
      </section>

      <!-- Hoi4 Sorsol√°s -->
      <section id="sorsolas">
        <h1>HOI4 Road to 56 ‚Äì Sorsol√≥</h1>

        <div class="controls-top">
          <button id="resetAllBtn">Teljes Sorsol√°s Vissza√°ll√≠t√°sa</button>
        </div>

        <div class="options-panel">
          <label for="balanceCountriesByStrength">
            <input type="checkbox" id="balanceCountriesByStrength" checked />
            Orsz√°gok er≈ëss√©galap√∫ kiegyens√∫lyoz√°sa a csapatok k√∂z√∂tt
          </label>
        </div>

        <div class="last-picked-display">
          Legut√≥bb: J√°t√©kos: <span id="lastPickedPlayer">-</span> | Orsz√°g:
          <span id="lastPickedCountry">-</span>
        </div>

        <div id="spinResultOverlay" class="spin-result-overlay">
          <div id="spunItemDisplay" class="spun-item-display">Kip√∂rgetve: -</div>
          <button id="nextSpinStepButton" class="next-spin-step-button">
            K√∂vetkez≈ë
          </button>
        </div>

        <div class="flex">
          <div class="box">
            <h2>
              J√°t√©kosok <span class="count-display" id="playerListCount">(0)</span>
            </h2>
            <input id="playerName" type="text" placeholder="N√©v" />
            <input
              id="playerSkill"
              type="number"
              placeholder="K√©pess√©g 1‚Äì10"
              min="1"
              max="10"
            />
            <button id="addPlayerBtn" onclick="handlePlayerSubmit()">
              Hozz√°ad√°s
            </button>
            <ul id="playersList"></ul>
          </div>

          <div class="box">
            <h2>
              Orsz√°gok <span class="count-display" id="countryListCount">(0)</span>
            </h2>
            <input id="countryName" type="text" placeholder="Orsz√°g neve" />
            <input
              id="countryStrength"
              type="number"
              placeholder="Er≈ëss√©g 1-10"
              min="1"
              max="10"
            />
            <button id="addCountryBtn" onclick="handleCountrySubmit()">
              Hozz√°ad√°s
            </button>
            <ul id="countriesList"></ul>
          </div>

          <div class="box">
            <h2>Csapatok</h2>
            <div id="teamWheelContainer" class="wheel-container">
              <div class="pointer">‚óÑ</div>
              <canvas id="teamWheel" width="250" height="250"></canvas>
            </div>
            <button id="spinTeamBtn">Csapat oszt√°s / Forgat√°s</button>
            <h3>
              Csapat 1 j√°t√©kosok
              <span class="count-display" id="team1PlayerCount">(0)</span>
            </h3>
            <ul id="playerBasket1" class="player-basket"></ul>
            <h3>
              Csapat 2 j√°t√©kosok
              <span class="count-display" id="team2PlayerCount">(0)</span>
            </h3>
            <ul id="playerBasket2" class="player-basket"></ul>
          </div>

          <div class="box">
            <h2>
              Orsz√°gok <span class="count-display" id="countryBoxCount">(0)</span>
            </h2>
            <div id="countryWheelContainer" class="wheel-container">
              <div class="pointer">‚óÑ</div>
              <canvas id="countryWheel" width="250" height="250"></canvas>
            </div>
            <button id="spinCountryBtn">Orsz√°g oszt√°s / Forgat√°s</button>

            <div id="countryGridsContainer">
              <div class="team-grid-wrapper" id="team1CountryGridWrapper">
                <h3>
                  Csapat 1 orsz√°gok
                  <span class="count-display" id="team1CountryCount">(0/9)</span>
                  <button
                    class="grid-zoom-btn"
                    data-targetwrapper="team1CountryGridWrapper"
                    title="Nagy√≠t√°s/Kicsiny√≠t√©s"
                  >
                    üîç
                  </button>
                </h3>
                <div id="countrySlots1" class="basket-grid"></div>
              </div>
              <div class="team-grid-wrapper" id="team2CountryGridWrapper">
                <h3>
                  Csapat 2 orsz√°gok
                  <span class="count-display" id="team2CountryCount">(0/9)</span>
                  <button
                    class="grid-zoom-btn"
                    data-targetwrapper="team2CountryGridWrapper"
                    title="Nagy√≠t√°s/Kicsiny√≠t√©s"
                  >
                    üîç
                  </button>
                </h3>
                <div id="countrySlots2" class="basket-grid"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Szavaz√°s -->
      <section id="szavazas">
        <h2>Szavaz√°sok</h2>
        <div id="pollCreator" class="poll-card">
          <h3>√öj szavaz√°s l√©trehoz√°sa</h3>
          <p id="pollCreatorNotice" class="poll-hint"></p>
          <form id="createPollForm">
            <input
              id="questionInput"
              class="poll-text-input"
              type="text"
              placeholder="K√©rd√©s"
              required
            />
            <div id="optionsContainer" class="poll-options-inputs"></div>
            <div class="poll-creator-actions">
              <button type="button" id="addOptionBtn" class="poll-button poll-secondary-btn">
                √öj v√°laszlehet≈ës√©g
              </button>
              <button type="submit" class="poll-button poll-primary-btn">
                Szavaz√°s l√©trehoz√°sa
              </button>
            </div>
          </form>
        </div>
        <div id="pollList" class="poll-list"></div>
      </section>

<!-- Programok -->
      <section id="programok">
        <div class="flex program-grid">
          <div class="box">
            <img src="program_icons/foto-apparatus.png" alt="FOTO-Appar√°tus ikon" class="program-icon" />
            <h3>FOTO-Appar√°tus</h3>
            <p>Lefot√≥zza a fitym√°dat bizonyos id≈ëk√∂z√∂nk√©nt</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 2</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 3</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 4</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
        </div>
      </section>

      <section id="admin">
        <h2>Felhaszn√°l√≥k Kezel√©se</h2>
        <p class="admin-description">
          √Åll√≠tsd be felhaszn√°l√≥nk√©nt, hogy ki t√∂lthet fel, valamint a felt√∂lt√©sekhez tartoz√≥ m√©ret- √©s darabkorl√°tokat.
        </p>
        <div id="userListContainer"></div>
        <button id="savePermissionsBtn">V√°ltoztat√°sok Ment√©se</button>
      </section>

      <section id="profile">
        <h2>Profil Be√°ll√≠t√°sok</h2>
        <div class="poll-card">
          <h3>Profilk√©p M√≥dos√≠t√°sa</h3>
          <img id="profileAvatarPreview" src="program_icons/default-avatar.png" alt="Profile Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem;">
          <input type="file" id="avatarInput" accept="image/*" style="display: block; margin-bottom: 1rem;">
          <button id="uploadAvatarBtn" class="poll-button">Felt√∂lt√©s</button>
          <p id="avatarUploadStatus" class="upload-status"></p>
        </div>
        <div class="poll-card" style="margin-top: 1rem;">
          <h3>Felhaszn√°l√≥n√©v M√≥dos√≠t√°sa</h3>
          <form id="updateUsernameForm">
            <input type="text" id="newUsername" class="poll-text-input" placeholder="√öj felhaszn√°l√≥n√©v" required>
            <button type="submit" class="poll-button">Ment√©s</button>
          </form>
        </div>
        <div class="poll-card" style="margin-top: 1rem;">
          <h3>Jelsz√≥ M√≥dos√≠t√°sa</h3>
          <form id="updatePasswordForm">
            <input type="password" id="currentPassword" class="poll-text-input" placeholder="Jelenlegi jelsz√≥" required>
            <input type="password" id="newPassword" class="poll-text-input" placeholder="√öj jelsz√≥" required>
            <button type="submit" class="poll-button">Ment√©s</button>
          </form>
        </div>
      </section>
    </main>

    <footer>
      <p>¬© 2025 UMGKL HUB Minden jog fenntartva</p>
    </footer>

    <script>
      const summaryToggleBtn = document.getElementById("summaryToggleBtn");
      const summaryCard = document.getElementById("summaryCard");
      const summaryCloseBtn = document.getElementById("summaryCloseBtn");
      const videoGridContainer = document.getElementById("video-grid-container");
      const showUploadModalBtn = document.getElementById("showUploadModalBtn");
      const uploadModal = document.getElementById("uploadModal");
      const closeUploadModalBtn = document.getElementById("closeUploadModal");
      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("fileInput");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadStatus = document.getElementById("uploadStatus");
      const selectedFileName = document.getElementById("selectedFileName");
      const ADMIN_SESSION_KEY = "isAdmin";
      const ADMIN_ONLY_SECTIONS = new Set(["admin", "programok"]);
      let selectedVideoFile = null;

      if (summaryToggleBtn && summaryCard) {
        summaryToggleBtn.addEventListener("click", () => {
          summaryCard.classList.add("summary-card--visible");
          summaryCard.setAttribute("aria-hidden", "false");
          summaryToggleBtn.setAttribute("aria-expanded", "true");
          summaryToggleBtn.classList.add("is-hidden");

          if (summaryCloseBtn) {
            summaryCloseBtn.focus();
          }
        });
      }

      if (summaryCloseBtn && summaryCard && summaryToggleBtn) {
        summaryCloseBtn.addEventListener("click", () => {
          summaryCard.classList.remove("summary-card--visible");
          summaryCard.setAttribute("aria-hidden", "true");
          summaryToggleBtn.setAttribute("aria-expanded", "false");
          summaryToggleBtn.classList.remove("is-hidden");
          summaryToggleBtn.focus();
        });
      }

      function isAdminUser() {
        return localStorage.getItem(ADMIN_SESSION_KEY) === "true";
      }

      function getAccessibleNavLinks() {
        return Array.from(document.querySelectorAll("nav a")).filter((link) => {
          return !(link.dataset.requiresAdmin === "true" && !isAdminUser());
        });
      }

      async function loadVideos() {
        if (!videoGridContainer) {
          return;
        }

        videoGridContainer.innerHTML = "";

        try {
          const response = await fetch("/api/videos");

          if (!response.ok) {
            throw new Error("Nem siker√ºlt bet√∂lteni a vide√≥kat.");
          }

          const videos = await response.json();

          if (!Array.isArray(videos) || videos.length === 0) {
            videoGridContainer.innerHTML = "<p>M√©g senki nem t√∂lt√∂tt fel vide√≥t.</p>";
            return;
          }

          videos.forEach((video) => {
            const card = document.createElement("div");
            card.className = "video-card";

            const videoElement = document.createElement("video");
            videoElement.src = `/uploads/${video.filename}`;
            videoElement.controls = true;
            videoElement.preload = "metadata";

            const uploader = document.createElement("p");
            uploader.textContent = `Felt√∂lt√∂tte: ${video.username || "Ismeretlen"}`;

            card.appendChild(videoElement);
            card.appendChild(uploader);

            videoGridContainer.appendChild(card);
          });
        } catch (error) {
          console.error("Vide√≥k bet√∂lt√©si hib√°ja:", error);
          videoGridContainer.innerHTML = "<p>Nem siker√ºlt bet√∂lteni a vide√≥kat.</p>";
        }
      }

      function resetUploadModal() {
        selectedVideoFile = null;
        if (uploadBtn) {
          uploadBtn.disabled = true;
        }
        if (uploadStatus) {
          uploadStatus.textContent = "";
        }
        if (selectedFileName) {
          selectedFileName.textContent = "Nincs kiv√°lasztott f√°jl.";
        }
        if (fileInput) {
          fileInput.value = "";
        }
        if (dropZone) {
          dropZone.classList.remove("drag-over");
        }
      }

      function openUploadModal() {
        if (uploadModal) {
          uploadModal.style.display = "flex";
        }
        resetUploadModal();
      }

      function closeUploadModal() {
        if (uploadModal) {
          uploadModal.style.display = "none";
        }
        resetUploadModal();
      }

      function handleFileSelection(file) {
        if (!file) {
          return;
        }
        selectedVideoFile = file;
        if (selectedFileName) {
          selectedFileName.textContent = `Kiv√°lasztott f√°jl: ${file.name}`;
        }
        if (uploadBtn) {
          uploadBtn.disabled = false;
        }
        if (uploadStatus) {
          uploadStatus.textContent = "";
        }
      }

      if (showUploadModalBtn && uploadModal) {
        showUploadModalBtn.addEventListener("click", () => {
          if (!isUserLoggedIn()) {
            alert("A felt√∂lt√©shez be kell jelentkezned.");
            return;
          }
          openUploadModal();
        });
      }

      if (closeUploadModalBtn) {
        closeUploadModalBtn.addEventListener("click", closeUploadModal);
      }

      if (uploadModal) {
        uploadModal.addEventListener("click", (event) => {
          if (event.target === uploadModal) {
            closeUploadModal();
          }
        });
      }

      if (dropZone && fileInput) {
        dropZone.addEventListener("click", () => fileInput.click());

        dropZone.addEventListener("dragover", (event) => {
          event.preventDefault();
          dropZone.classList.add("drag-over");
        });

        ["dragleave", "dragend"].forEach((eventName) => {
          dropZone.addEventListener(eventName, (event) => {
            event.preventDefault();
            dropZone.classList.remove("drag-over");
          });
        });

        dropZone.addEventListener("drop", (event) => {
          event.preventDefault();
          dropZone.classList.remove("drag-over");
          const files = event.dataTransfer?.files;
          if (files && files.length > 0) {
            handleFileSelection(files[0]);
          }
        });
      }

      if (fileInput) {
        fileInput.addEventListener("change", (event) => {
          const files = event.target.files;
          if (files && files.length > 0) {
            handleFileSelection(files[0]);
          } else {
            resetUploadModal();
          }
        });
      }

      if (uploadBtn) {
        uploadBtn.addEventListener("click", async () => {
          if (!isUserLoggedIn()) {
            alert("A felt√∂lt√©shez be kell jelentkezned.");
            return;
          }

          if (!selectedVideoFile) {
            alert("V√°lassz ki egy vide√≥f√°jlt a felt√∂lt√©shez.");
            return;
          }

          const formData = new FormData();
          formData.append("video", selectedVideoFile);

          uploadBtn.disabled = true;
          if (uploadStatus) {
            uploadStatus.textContent = "Felt√∂lt√©s folyamatban...";
          }

          try {
            const response = await fetch("/upload", {
              method: "POST",
              headers: buildAuthHeaders(),
              body: formData,
            });

            const result = await response.json().catch(() => null);

            if (!response.ok) {
              const message = (result && result.message) || "Nem siker√ºlt felt√∂lteni a vide√≥t.";
              throw new Error(message);
            }

            if (uploadStatus) {
              uploadStatus.textContent = (result && result.message) || "Vide√≥ sikeresen felt√∂ltve.";
            }
            await loadVideos();
            setTimeout(() => {
              closeUploadModal();
            }, 800);
          } catch (error) {
            console.error("Vide√≥ felt√∂lt√©si hiba:", error);
            if (uploadStatus) {
              uploadStatus.textContent = error.message || "Nem siker√ºlt felt√∂lteni a vide√≥t.";
            }
          } finally {
            if (uploadBtn) {
              uploadBtn.disabled = false;
            }
          }
        });
      }

      function showSection(target, shouldPushState = true) {
        const navLinks = getAccessibleNavLinks();
        const sections = document.querySelectorAll("main section");
        const availableTargets = new Set(navLinks.map((link) => link.dataset.section));

        if (!availableTargets.has(target)) {
          target = "home";
        }

        document.querySelectorAll("nav a").forEach((link) => {
          const requiresAdmin = link.dataset.requiresAdmin === "true";
          const isActive = link.dataset.section === target;

          if (requiresAdmin && !isAdminUser()) {
            link.classList.remove("active");
            return;
          }

          link.classList.toggle("active", isActive);
        });

        sections.forEach((sec) => {
          const requiresAdmin = ADMIN_ONLY_SECTIONS.has(sec.id);

          if (sec.id === target && (!requiresAdmin || isAdminUser())) {
            sec.classList.add("active");
          } else {
            sec.classList.remove("active");
          }
        });

        if (target === "klipek") {
          loadVideos();
        }

        if (target === "szavazas") {
          refreshPollsIfVisible();
        }

        if (shouldPushState) {
          history.pushState(null, "", `#${target}`);
        }
      }

      document.querySelectorAll("nav a").forEach((link) => {
        link.addEventListener("click", (e) => {
          const requiresAdmin = link.dataset.requiresAdmin === "true";

          if (requiresAdmin && !isAdminUser()) {
            e.preventDefault();
            return;
          }

          e.preventDefault();
          showSection(link.dataset.section);
        });
      });

      // Oldal bet√∂lt√©sekor a hash alapj√°n nyitjuk meg a megfelel≈ë szekci√≥t
      window.addEventListener("load", () => {
        const hash = location.hash.replace("#", "") || "home";
        showSection(hash, false);
      });
    </script>

  <script>
    const loginModal = document.getElementById("loginModal");
    const closeLogin = document.getElementById("closeLogin");
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authLoggedOut = document.getElementById("authLoggedOut");
    const authLoggedIn = document.getElementById("authLoggedIn");
    const userGreeting = document.getElementById("userGreeting");
    const adminNavBtn = document.getElementById("adminNavBtn");
    const programNavBtn = document.getElementById("programNavBtn");
    const userListContainer = document.getElementById("userListContainer");
    const savePermissionsBtn = document.getElementById("savePermissionsBtn");
    const pollCreator = document.getElementById("pollCreator");
    const pollCreatorNotice = document.getElementById("pollCreatorNotice");
    const createPollForm = document.getElementById("createPollForm");
    const questionInput = document.getElementById("questionInput");
    const optionsContainer = document.getElementById("optionsContainer");
    const addOptionBtn = document.getElementById("addOptionBtn");
    const pollListContainer = document.getElementById("pollList");
    const pollSection = document.getElementById("szavazas");

    const SESSION_KEYS = {
      token: "token",
      username: "username",
      isAdmin: ADMIN_SESSION_KEY,
      profilePictureFilename: "profilePictureFilename",
    };
    const POLL_MIN_OPTIONS = 2;
    let pollsShouldRefresh = true;

    function isPollSectionActive() {
      return pollSection?.classList.contains("active");
    }

    function refreshPollsIfVisible() {
      if (!isPollSectionActive() || !pollsShouldRefresh) {
        return;
      }

      pollsShouldRefresh = false;
      loadPolls();
    }

    function markPollsForRefresh() {
      pollsShouldRefresh = true;
      refreshPollsIfVisible();
    }

    function getStoredToken() {
      return localStorage.getItem(SESSION_KEYS.token);
    }

    function isUserLoggedIn() {
      return !!getStoredToken();
    }

    function buildAuthHeaders() {
      const token = getStoredToken();
      if (!token) {
        return {};
      }
      return {
        Authorization: `Bearer ${token}`,
      };
    }

    if (savePermissionsBtn) {
      savePermissionsBtn.disabled = true;
    }

    function openLoginModal() {
      if (loginForm) {
        loginForm.reset();
      }
      loginModal.style.display = "flex";
    }

    function createOptionRow(value = "") {
      const row = document.createElement("div");
      row.className = "poll-option-row";

      const input = document.createElement("input");
      input.type = "text";
      input.className = "poll-option-input";
      input.placeholder = "V√°laszlehet≈ës√©g";
      input.required = true;
      input.value = value;

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "poll-option-remove";
      removeBtn.setAttribute("aria-label", "V√°laszlehet≈ës√©g t√∂rl√©se");
      removeBtn.textContent = "‚úï";
      removeBtn.addEventListener("click", () => {
        if (!optionsContainer) {
          return;
        }
        row.remove();
        ensureMinimumOptionRows();
        updateOptionRemoveButtons();
      });

      row.appendChild(input);
      row.appendChild(removeBtn);

      return row;
    }

    function updateOptionRemoveButtons() {
      if (!optionsContainer) {
        return;
      }

      const rows = optionsContainer.querySelectorAll(".poll-option-row");
      rows.forEach((row) => {
        const removeBtn = row.querySelector(".poll-option-remove");
        if (removeBtn) {
          removeBtn.disabled = rows.length <= POLL_MIN_OPTIONS;
        }
      });
    }

    function addOptionRow(value = "") {
      if (!optionsContainer) {
        return null;
      }

      const row = createOptionRow(value);
      optionsContainer.appendChild(row);
      updateOptionRemoveButtons();
      return row;
    }

    function ensureMinimumOptionRows() {
      if (!optionsContainer) {
        return;
      }

      const currentRows = optionsContainer.querySelectorAll(".poll-option-row").length;
      const missing = POLL_MIN_OPTIONS - currentRows;

      if (missing > 0) {
        for (let i = 0; i < missing; i += 1) {
          addOptionRow();
        }
      }

      updateOptionRemoveButtons();
    }

    function resetPollForm() {
      if (createPollForm) {
        createPollForm.reset();
      }

      if (optionsContainer) {
        optionsContainer.innerHTML = "";
      }

      ensureMinimumOptionRows();
    }

    function updatePollCreatorState(forceLoggedInState) {
      if (!pollCreator || !createPollForm) {
        return;
      }

      const loggedIn =
        typeof forceLoggedInState === "boolean" ? forceLoggedInState : isUserLoggedIn();

      if (loggedIn) {
        createPollForm.style.display = "block";
        if (pollCreatorNotice) {
          pollCreatorNotice.textContent =
            "Adj meg egy k√©rd√©st √©s legal√°bb k√©t v√°laszlehet≈ës√©get.";
        }
        ensureMinimumOptionRows();
      } else {
        createPollForm.style.display = "none";
        if (pollCreatorNotice) {
          pollCreatorNotice.textContent =
            "Szavaz√°st l√©trehozni csak bejelentkezett felhaszn√°l√≥k tudnak.";
        }
      }
    }

    function renderPoll(poll) {
        const card = document.createElement("div");
        card.className = "poll-card";

        const header = document.createElement("div");
        header.className = "poll-card-header";

        const title = document.createElement("h3");
        title.textContent = poll?.question || "Szavaz√°s";
        header.appendChild(title);

        const status = document.createElement("span");
        status.className = `poll-status ${poll?.is_active ? "poll-status--active" : "poll-status--closed"}`;
        status.textContent = poll?.is_active ? "Akt√≠v" : "Lez√°rt";
        header.appendChild(status);

        card.appendChild(header);

        const creatorName = poll?.creator_username || "Ismeretlen";
        const meta = document.createElement("div");
        meta.className = "poll-meta";
        let metaText = `L√©trehozta: ${creatorName}`;
        if (poll?.created_at) {
            const createdAt = new Date(poll.created_at);
            if (!Number.isNaN(createdAt.valueOf())) {
                metaText += ` ‚Ä¢ ${createdAt.toLocaleString("hu-HU")}`;
            }
        }
        meta.textContent = metaText;
        card.appendChild(meta);

        if (poll?.is_active && !isUserLoggedIn()) {
            const notice = document.createElement("div");
            notice.className = "poll-hint";
            notice.textContent = "Szavazni csak bejelentkezett felhaszn√°l√≥k tudnak.";
            card.appendChild(notice);
        }

        const optionsWrapper = document.createElement("div");
        optionsWrapper.className = "poll-options-results";

        const totalVotes = Number(poll?.totalVotes) || 0;

        if (Array.isArray(poll?.options)) {
            poll.options.forEach((option) => {
                const optionResult = document.createElement("div");
                optionResult.className = "poll-option-result";
                if (poll?.userVoteOptionId === option.id) {
                    optionResult.classList.add("poll-option-result--selected");
                }

                const headerRow = document.createElement("div");
                headerRow.className = "poll-option-header";

                const label = document.createElement("div");
                label.className = "poll-option-label";
                label.textContent = option?.option_text || "V√°laszlehet≈ës√©g";
                headerRow.appendChild(label);

                const count = document.createElement("div");
                count.className = "poll-option-count";
                const votes = Number(option?.vote_count) || 0;
                const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                count.textContent = `${votes} szavazat (${percentage}%)`;
                headerRow.appendChild(count);

                if (poll?.is_active && !poll?.userVoteOptionId && isUserLoggedIn()) {
                    const voteBtn = document.createElement("button");
                    voteBtn.type = "button";
                    voteBtn.className = "poll-button poll-vote-btn";
                    voteBtn.textContent = "Szavazok";
                    voteBtn.addEventListener("click", () => handlePollVote(poll.id, option.id, voteBtn));
                    headerRow.appendChild(voteBtn);
                } else if (poll?.userVoteOptionId === option.id) {
                    const badge = document.createElement("span");
                    badge.className = "poll-badge";
                    badge.textContent = "Szavazatod";
                    headerRow.appendChild(badge);
                }

                optionResult.appendChild(headerRow);

                const bar = document.createElement("div");
                bar.className = "poll-result-bar";
                const fill = document.createElement("div");
                fill.className = "poll-result-bar-fill";
                const fillWidth = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
                fill.style.width = `${fillWidth}%`;
                bar.appendChild(fill);
                optionResult.appendChild(bar);

                const votersElement = document.createElement("div");
                votersElement.className = "poll-voters";
                if (Array.isArray(option?.voters) && option.voters.length > 0) {
                    const names = option.voters
                        .map((voter) => voter?.username || `#${voter?.id ?? "?"}`)
                        .join(", ");
                    votersElement.textContent = `Szavaztak: ${names}`;
                } else {
                    votersElement.textContent = "M√©g nincs szavazat.";
                }
                optionResult.appendChild(votersElement);

                optionsWrapper.appendChild(optionResult);
            });
        }

        card.appendChild(optionsWrapper);

        const totalVotesInfo = document.createElement("div");
        totalVotesInfo.className = "poll-total-votes";
        totalVotesInfo.textContent = `√ñsszes szavazat: ${totalVotes}`;
        card.appendChild(totalVotesInfo);

        const actions = document.createElement("div");
        actions.className = "poll-actions";
        let hasAction = false;

        if (poll?.canClose) {
            const closeBtn = document.createElement("button");
            closeBtn.type = "button";
            closeBtn.className = "poll-button poll-secondary-btn";
            closeBtn.textContent = "Szavaz√°s lez√°r√°sa";
            closeBtn.addEventListener("click", () => handleClosePoll(poll.id, closeBtn));
            actions.appendChild(closeBtn);
            hasAction = true;
        }

        if (isAdminUser()) {
            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "poll-button poll-close-btn";
            deleteBtn.textContent = "T√∂rl√©s (Admin)";
            deleteBtn.addEventListener("click", () => handleDeletePoll(poll.id, deleteBtn));
            actions.appendChild(deleteBtn);
            hasAction = true;
        }

        if (hasAction) {
            card.appendChild(actions);
        }

        return card;
    }

    async function loadPolls() {
      if (!pollListContainer) {
        return;
      }

      pollsShouldRefresh = false;

      pollListContainer.innerHTML = "";
      const loadingElement = document.createElement("div");
      loadingElement.className = "poll-empty";
      loadingElement.textContent = "Szavaz√°sok bet√∂lt√©se...";
      pollListContainer.appendChild(loadingElement);

      try {
        const response = await fetch("/api/polls", { headers: buildAuthHeaders() });

        if (!response.ok) {
          throw new Error("Nem siker√ºlt bet√∂lteni a szavaz√°sokat.");
        }

        const polls = await response.json();
        pollListContainer.innerHTML = "";

        if (!Array.isArray(polls) || polls.length === 0) {
          const emptyElement = document.createElement("div");
          emptyElement.className = "poll-empty";
          emptyElement.textContent = "Jelenleg nincs akt√≠v szavaz√°s.";
          pollListContainer.appendChild(emptyElement);
          return;
        }

        polls.forEach((poll) => {
          pollListContainer.appendChild(renderPoll(poll));
        });
      } catch (error) {
        console.error("Szavaz√°sok bet√∂lt√©si hiba:", error);
        pollListContainer.innerHTML = "";
        const errorElement = document.createElement("div");
        errorElement.className = "poll-empty";
        errorElement.textContent = "Nem siker√ºlt bet√∂lteni a szavaz√°sokat.";
        pollListContainer.appendChild(errorElement);
      }
    }

    async function handlePollVote(pollId, optionId, button) {
      if (!isUserLoggedIn()) {
        alert("Szavaz√°shoz be kell jelentkezned.");
        if (typeof openLoginModal === "function") {
          openLoginModal();
        }
        return;
      }

      const originalText = button ? button.textContent : "";
      if (button) {
        button.disabled = true;
        button.textContent = "K√ºld√©s...";
      }

      try {
        const response = await fetch(`/api/polls/${pollId}/vote`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...buildAuthHeaders(),
          },
          body: JSON.stringify({ optionId }),
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message =
            payload && payload.message
              ? payload.message
              : "Nem siker√ºlt r√∂gz√≠teni a szavazatot.";
          throw new Error(message);
        }

        await loadPolls();
      } catch (error) {
        console.error("Szavazat ment√©si hiba:", error);
        alert(error.message || "Nem siker√ºlt r√∂gz√≠teni a szavazatot.");
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = originalText || "Szavazok";
        }
      }
    }

    async function handleClosePoll(pollId, button) {
      if (!isUserLoggedIn()) {
        alert("A szavaz√°s lez√°r√°s√°hoz be kell jelentkezned.");
        if (typeof openLoginModal === "function") {
          openLoginModal();
        }
        return;
      }

      if (!confirm("Biztosan lez√°rod a szavaz√°st?")) {
        return;
      }

      const originalText = button ? button.textContent : "";
      if (button) {
        button.disabled = true;
        button.textContent = "Lez√°r√°s...";
      }

      try {
        const response = await fetch(`/api/polls/${pollId}/close`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...buildAuthHeaders(),
          },
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message =
            payload && payload.message
              ? payload.message
              : "Nem siker√ºlt lez√°rni a szavaz√°st.";
          throw new Error(message);
        }

        await loadPolls();
      } catch (error) {
        console.error("Szavaz√°s lez√°r√°si hiba:", error);
        alert(error.message || "Nem siker√ºlt lez√°rni a szavaz√°st.");
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = originalText || "Szavaz√°s lez√°r√°sa";
        }
      }
    }
    async function handleDeletePoll(pollId, button) {
        if (!isUserLoggedIn() || !isAdminUser()) {
            alert("Csak adminisztr√°torok t√∂r√∂lhetnek szavaz√°sokat.");
            return;
        }

        if (!confirm("Biztosan t√∂rl√∂d ezt a szavaz√°st? Ez a m≈±velet nem vonhat√≥ vissza.")) {
            return;
        }

        const originalText = button ? button.textContent : "";
        if (button) {
            button.disabled = true;
            button.textContent = "T√∂rl√©s...";
        }

        try {
            const response = await fetch(`/api/polls/${pollId}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    ...buildAuthHeaders(),
                },
            });

            const payload = await response.json().catch(() => ({}));

            if (!response.ok) {
                const message =
                    payload && payload.message
                        ? payload.message
                        : "Nem siker√ºlt t√∂r√∂lni a szavaz√°st.";
                throw new Error(message);
            }

            await loadPolls();
        } catch (error) {
            console.error("Szavaz√°s t√∂rl√©si hiba:", error);
            alert(error.message || "Nem siker√ºlt t√∂r√∂lni a szavaz√°st.");
        } finally {
            if (button) {
                button.disabled = false;
                button.textContent = originalText || "T√∂rl√©s (Admin)";
            }
        }
    }

    if (addOptionBtn) {
      addOptionBtn.addEventListener("click", () => {
        if (!isUserLoggedIn()) {
          alert("Szavaz√°st l√©trehozni csak bejelentkezve tudsz.");
          if (typeof openLoginModal === "function") {
            openLoginModal();
          }
          return;
        }

        addOptionRow();
      });
    }

    if (createPollForm) {
      createPollForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        if (!isUserLoggedIn()) {
          alert("Szavaz√°st l√©trehozni csak bejelentkezve tudsz.");
          if (typeof openLoginModal === "function") {
            openLoginModal();
          }
          return;
        }

        const question = questionInput ? questionInput.value.trim() : "";
        const optionInputs = optionsContainer
          ? Array.from(optionsContainer.querySelectorAll(".poll-option-input"))
          : [];
        const optionValues = optionInputs.map((input) => input.value.trim()).filter(Boolean);

        const uniqueOptions = [];
        const seenOptions = new Set();
        optionValues.forEach((option) => {
          const key = option.toLowerCase();
          if (!seenOptions.has(key)) {
            seenOptions.add(key);
            uniqueOptions.push(option);
          }
        });

        if (!question || uniqueOptions.length < POLL_MIN_OPTIONS) {
          alert("Adj meg egy k√©rd√©st √©s legal√°bb k√©t k√ºl√∂nb√∂z≈ë v√°laszlehet≈ës√©get!");
          return;
        }

        const submitButton = createPollForm.querySelector('button[type="submit"]');
        const originalText = submitButton ? submitButton.textContent : "";

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "L√©trehoz√°s...";
        }

        try {
          const response = await fetch("/api/polls", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...buildAuthHeaders(),
            },
            body: JSON.stringify({ question, options: uniqueOptions }),
          });

          const payload = await response.json().catch(() => ({}));

          if (!response.ok) {
            const message =
              payload && payload.message
                ? payload.message
                : "Nem siker√ºlt l√©trehozni a szavaz√°st.";
            throw new Error(message);
          }

          resetPollForm();
          updatePollCreatorState(true);
          await loadPolls();
        } catch (error) {
          console.error("Szavaz√°s l√©trehoz√°si hiba:", error);
          alert(error.message || "Nem siker√ºlt l√©trehozni a szavaz√°st.");
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || "Szavaz√°s l√©trehoz√°sa";
          }
        }
      });
    }

    ensureMinimumOptionRows();
    updatePollCreatorState();
    markPollsForRefresh();

    function updateAdminNavVisibility() {
      const isAdmin = isAdminUser();

      if (adminNavBtn) {
        adminNavBtn.style.display = isAdmin ? "inline-block" : "none";
      }

      if (programNavBtn) {
        programNavBtn.style.display = isAdmin ? "inline-block" : "none";
      }

      if (!isAdmin) {
        const activeSection = document.querySelector("main section.active");
        if (
          activeSection &&
          typeof ADMIN_ONLY_SECTIONS !== "undefined" &&
          ADMIN_ONLY_SECTIONS.has(activeSection.id)
        ) {
          showSection("home");
        }
        if (userListContainer) {
          userListContainer.innerHTML = "";
        }
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
      }
    }

    function updateUIForLoggedIn(username, profilePictureFilename) {
      if (userGreeting) {
        userGreeting.textContent = `Szia, ${username}!`;
      }
      const userAvatar = document.getElementById('userAvatar');
      if (userAvatar) {
          userAvatar.src = profilePictureFilename ? `/uploads/avatars/${profilePictureFilename}` : 'program_icons/default-avatar.png';
      }
      const profileAvatarPreview = document.getElementById('profileAvatarPreview');
      if (profileAvatarPreview) {
          profileAvatarPreview.src = profilePictureFilename ? `/uploads/avatars/${profilePictureFilename}` : 'program_icons/default-avatar.png';
      }
      if (authLoggedOut) {
        authLoggedOut.style.display = "none";
      }
      if (authLoggedIn) {
        authLoggedIn.style.display = "flex";
      }

      updateAdminNavVisibility();
      updatePollCreatorState(true);
      markPollsForRefresh();
    }

    function updateUIForLoggedOut() {
      // Clear session data from localStorage
      localStorage.removeItem(SESSION_KEYS.token);
      localStorage.removeItem(SESSION_KEYS.username);
      localStorage.removeItem(SESSION_KEYS.isAdmin);
      localStorage.removeItem(SESSION_KEYS.profilePictureFilename);

      if (authLoggedOut) {
        authLoggedOut.style.display = "flex";
      }
      if (authLoggedIn) {
        authLoggedIn.style.display = "none";
      }
      if (userGreeting) {
        userGreeting.textContent = "";
      }
      updateAdminNavVisibility();
      updatePollCreatorState(false);
      markPollsForRefresh();
    }

    if (loginBtn) {
      loginBtn.addEventListener("click", openLoginModal);
    }

    function renderUserList(users) {
      if (!userListContainer) {
        return;
      }

      userListContainer.innerHTML = "";

      if (!Array.isArray(users) || users.length === 0) {
        userListContainer.textContent = "Nincs megjelen√≠thet≈ë felhaszn√°l√≥.";
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
        return;
      }

      const table = document.createElement("table");
      table.className = "user-table";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Felhaszn√°l√≥n√©v</th>
          <th>Felt√∂lt√©si jogosults√°g</th>
          <th>Max f√°jlm√©ret (MB)</th>
          <th>Vide√≥ limit</th>
          <th>Felt√∂lt√∂tt vide√≥k</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      users.forEach((user) => {
        const row = document.createElement("tr");
        row.dataset.userId = user.id;

        const usernameCell = document.createElement("td");
        usernameCell.textContent = user.username;
        row.appendChild(usernameCell);

        const permissionCell = document.createElement("td");
        const label = document.createElement("label");
        label.className = "permission-toggle";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = Number(user.can_upload) === 1;
        label.appendChild(checkbox);
        label.append(" Felt√∂lthet");
        permissionCell.appendChild(label);
        row.appendChild(permissionCell);

        const maxFileSizeCell = document.createElement("td");
        const maxFileInput = document.createElement("input");
        maxFileInput.type = "number";
        maxFileInput.min = "1";
        maxFileInput.required = true;
        maxFileInput.name = "maxFileSizeMb";
        maxFileInput.value = Number.parseInt(user.max_file_size_mb, 10) || "";
        maxFileSizeCell.appendChild(maxFileInput);
        row.appendChild(maxFileSizeCell);

        const maxVideosCell = document.createElement("td");
        const maxVideosInput = document.createElement("input");
        maxVideosInput.type = "number";
        maxVideosInput.min = "1";
        maxVideosInput.required = true;
        maxVideosInput.name = "maxVideos";
        maxVideosInput.value = Number.parseInt(user.max_videos, 10) || "";
        maxVideosCell.appendChild(maxVideosInput);
        row.appendChild(maxVideosCell);

        const uploadsCell = document.createElement("td");
        uploadsCell.textContent = Number.parseInt(user.upload_count, 10) || 0;
        row.appendChild(uploadsCell);

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      userListContainer.appendChild(table);

      if (savePermissionsBtn) {
        savePermissionsBtn.disabled = false;
      }
    }

    async function loadAdminPanel() {
      if (!isUserLoggedIn()) {
        alert("Nincs √©rv√©nyes hiteles√≠t√©s.");
        return;
      }

      try {
        const response = await fetch("/api/users", {
          method: "GET",
          headers: buildAuthHeaders(),
        });

        const data = await response.json().catch(() => null);

        if (!response.ok) {
          const message = data && data.message ? data.message : "Nem siker√ºlt bet√∂lteni a felhaszn√°l√≥kat.";
          throw new Error(message);
        }

        renderUserList(Array.isArray(data) ? data : []);
      } catch (error) {
        console.error("Admin panel bet√∂lt√©si hiba:", error);
        alert(error.message || "Nem siker√ºlt bet√∂lteni az admin panel adatait.");
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
      }
    }

    if (savePermissionsBtn) {
      const originalButtonText = savePermissionsBtn.textContent;

      savePermissionsBtn.addEventListener("click", async () => {
        if (!isUserLoggedIn()) {
          alert("Nincs √©rv√©nyes hiteles√≠t√©s.");
          return;
        }

        if (!userListContainer) {
          alert("Nem tal√°lhat√≥ a felhaszn√°l√≥i lista.");
          return;
        }

        const tableBody = userListContainer.querySelector("tbody");
        if (!tableBody) {
          alert("Nincs ment√©sre v√°r√≥ adat.");
          return;
        }

        const rows = Array.from(tableBody.querySelectorAll("tr"));
        const invalidEntries = [];
        const permissionsToUpdate = rows
          .map((row) => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            const maxFileSizeInput = row.querySelector('input[name="maxFileSizeMb"]');
            const maxVideosInput = row.querySelector('input[name="maxVideos"]');
            const userIdAttr = row.dataset.userId;

            if (!checkbox || !maxFileSizeInput || !maxVideosInput || !userIdAttr) {
              return null;
            }

            const userId = Number.parseInt(userIdAttr, 10);
            if (Number.isNaN(userId)) {
              return null;
            }

            const maxFileSizeValue = Number.parseInt(maxFileSizeInput.value, 10);
            const maxVideosValue = Number.parseInt(maxVideosInput.value, 10);

            if (!Number.isFinite(maxFileSizeValue) || maxFileSizeValue <= 0 || !Number.isFinite(maxVideosValue) || maxVideosValue <= 0) {
              const usernameCell = row.querySelector("td");
              const identifier = usernameCell ? usernameCell.textContent.trim() : `ID ${userId}`;
              invalidEntries.push(identifier);
              return null;
            }

            return {
              userId,
              canUpload: checkbox.checked,
              maxFileSizeMb: maxFileSizeValue,
              maxVideos: maxVideosValue,
            };
          })
          .filter(Boolean);

        if (invalidEntries.length > 0) {
          alert(`Adj meg √©rv√©nyes, pozit√≠v limiteket a k√∂vetkez≈ë felhaszn√°l√≥kn√°l: ${invalidEntries.join(", ")}.`);
          return;
        }

        if (permissionsToUpdate.length === 0) {
          alert("Nincs ment√©sre v√°r√≥ adat.");
          return;
        }

        savePermissionsBtn.disabled = true;
        savePermissionsBtn.textContent = "Ment√©s folyamatban...";

        try {
          const response = await fetch("/api/users/permissions/batch-update", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...buildAuthHeaders(),
            },
            body: JSON.stringify(permissionsToUpdate),
          });

          const result = await response.json().catch(() => null);

          if (!response.ok) {
            const message = result && result.message ? result.message : "Nem siker√ºlt menteni a jogosults√°gokat.";
            throw new Error(message);
          }

          alert((result && result.message) || "Jogosults√°gok sikeresen friss√≠tve.");
          await loadAdminPanel();
        } catch (error) {
          console.error("Jogosults√°g ment√©si hiba:", error);
          alert(error.message || "Nem siker√ºlt menteni a jogosults√°gokat.");
        } finally {
          savePermissionsBtn.disabled = false;
          savePermissionsBtn.textContent = originalButtonText;
        }
      });
    }

    closeLogin.addEventListener("click", () => {
      loginModal.style.display = "none";
    });

    if (adminNavBtn) {
      adminNavBtn.addEventListener("click", loadAdminPanel);
    }

    const feedbackModal = document.getElementById("feedbackModal");
    const feedbackModalTitle = document.getElementById("feedbackModalTitle");
    const feedbackModalMessage = document.getElementById("feedbackModalMessage");
    const feedbackModalClose = document.getElementById("feedbackModalClose");
    const feedbackModalOk = document.getElementById("feedbackModalOk");
    let feedbackModalOnClose = null;

    const hideFeedbackModal = () => {
      feedbackModal.style.display = "none";
      feedbackModalTitle.textContent = "";
      feedbackModalMessage.textContent = "";
      const onClose = feedbackModalOnClose;
      feedbackModalOnClose = null;
      if (typeof onClose === "function") {
        onClose();
      }
    };

    const showFeedbackModal = ({ title, message, onClose }) => {
      feedbackModalTitle.textContent = title;
      feedbackModalMessage.textContent = message;
      feedbackModalOnClose = typeof onClose === "function" ? onClose : null;
      feedbackModal.style.display = "flex";
      feedbackModalOk.focus();
    };

    feedbackModalClose.addEventListener("click", hideFeedbackModal);
    feedbackModalOk.addEventListener("click", hideFeedbackModal);
    feedbackModal.addEventListener("click", (event) => {
      if (event.target === feedbackModal) {
        hideFeedbackModal();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && feedbackModal.style.display === "flex") {
        hideFeedbackModal();
      }
    });

    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        updateUIForLoggedOut();
        showFeedbackModal({
          title: "Kijelentkez√©s",
          message: "Sikeresen kijelentkezt√©l.",
        });
      });
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("loginUser").value;
      const password = document.getElementById("loginPass").value;

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await res.json();

        if (res.ok) {
          localStorage.setItem(SESSION_KEYS.token, data.token);
          localStorage.setItem(SESSION_KEYS.username, data.username);
          localStorage.setItem(SESSION_KEYS.isAdmin, data.isAdmin);
          if (data.profile_picture_filename) {
            localStorage.setItem(SESSION_KEYS.profilePictureFilename, data.profile_picture_filename);
          } else {
            localStorage.removeItem(SESSION_KEYS.profilePictureFilename);
          }

          updateUIForLoggedIn(data.username, data.profile_picture_filename);
          loginModal.style.display = "none";
          showFeedbackModal({
            title: "Sikeres bejelentkez√©s",
            message: data.message || "Sikeres bejelentkez√©s.",
          });
        } else {
          alert(data.message || "Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥.");
        }
      } catch (error) {
        console.error("Bejelentkez√©si hiba:", error);
        alert("Hiba t√∂rt√©nt a bejelentkez√©s sor√°n. Pr√≥b√°ld meg k√©s≈ëbb.");
      }
    });

    window.addEventListener("load", () => {
        ensureSessionOnLoad();
    });

    const userProfileLink = document.getElementById('userProfileLink');
    if (userProfileLink) {
        userProfileLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('profile');
        });
    }

    async function ensureSessionOnLoad() {
        const token = getStoredToken();
        if (!token) {
            updateUIForLoggedOut();
            return;
        }

        try {
            const response = await fetch('/api/profile', {
                method: 'GET',
                headers: buildAuthHeaders(),
            });

            if (response.status === 401 || response.status === 403) {
                // Token is invalid or expired
                updateUIForLoggedOut();
                return;
            }

            if (!response.ok) {
                // Other server errors, maybe retry later or show a generic error
                // For now, we'll just log out to be safe
                updateUIForLoggedOut();
                return;
            }

            const data = await response.json();

            // Update localStorage with the latest data from the server
            localStorage.setItem(SESSION_KEYS.token, token); // The token is still valid
            localStorage.setItem(SESSION_KEYS.username, data.username);
            localStorage.setItem(SESSION_KEYS.isAdmin, data.isAdmin);
            if (data.profile_picture_filename) {
                localStorage.setItem(SESSION_KEYS.profilePictureFilename, data.profile_picture_filename);
            } else {
                localStorage.removeItem(SESSION_KEYS.profilePictureFilename);
            }

            updateUIForLoggedIn(data.username, data.profile_picture_filename);
        } catch (error) {
            console.error('Hiba a munkamenet ellen≈ërz√©sekor:', error);
            // If there's a network error or the server is down, log out
            updateUIForLoggedOut();
        }
    }

    const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
    const avatarInput = document.getElementById('avatarInput');
    const avatarUploadStatus = document.getElementById('avatarUploadStatus');

    if (uploadAvatarBtn) {
        uploadAvatarBtn.addEventListener('click', async () => {
            if (!isUserLoggedIn()) {
                alert("A felt√∂lt√©shez be kell jelentkezned.");
                return;
            }

            const file = avatarInput.files[0];
            if (!file) {
                alert("V√°lassz ki egy k√©pf√°jlt a felt√∂lt√©shez.");
                return;
            }

            const formData = new FormData();
            formData.append('avatar', file);

            uploadAvatarBtn.disabled = true;
            avatarUploadStatus.textContent = "Felt√∂lt√©s folyamatban...";

            try {
                const response = await fetch('/api/profile/upload-avatar', {
                    method: 'POST',
                    headers: buildAuthHeaders(),
                    body: formData,
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Nem siker√ºlt felt√∂lteni a profilk√©pet.');
                }

                avatarUploadStatus.textContent = result.message;
                await ensureSessionOnLoad(); // Refresh session data to get new avatar filename
            } catch (error) {
                console.error('Profilk√©p felt√∂lt√©si hiba:', error);
                avatarUploadStatus.textContent = error.message;
            } finally {
                uploadAvatarBtn.disabled = false;
            }
        });
    }

    const updateUsernameForm = document.getElementById('updateUsernameForm');
    if (updateUsernameForm) {
        updateUsernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('newUsername').value;

            try {
                const res = await fetch('/api/profile/update-name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...buildAuthHeaders() },
                    body: JSON.stringify({ newUsername }),
                });

                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    await ensureSessionOnLoad();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Hiba t√∂rt√©nt a felhaszn√°l√≥n√©v friss√≠t√©se sor√°n.');
            }
        });
    }

    const updatePasswordForm = document.getElementById('updatePasswordForm');
    if (updatePasswordForm) {
        updatePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            try {
                const res = await fetch('/api/profile/update-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...buildAuthHeaders() },
                    body: JSON.stringify({ currentPassword, newPassword }),
                });

                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    updatePasswordForm.reset();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Hiba t√∂rt√©nt a jelsz√≥ friss√≠t√©se sor√°n.');
            }
        });
    }
  </script>

  <script src="HOI4-Porgonc/script.js"></script>
  </body>
</html>
