<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feldolgozási állapot</title>
    <link rel="icon" type="image/png" href="program_icons/oldal_logo.png" />
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f3f4f6;
        color: #111827;
        margin: 0;
        padding: 20px;
      }

      a {
        color: inherit;
      }

      .process-window {
        max-width: 980px;
        margin: 0 auto;
      }

      .process-window h1 {
        margin: 0 0 10px;
        font-size: 22px;
      }

      .process-window__subtitle {
        margin: 0 0 16px;
        color: #4b5563;
      }

      .process-window__status {
        margin: 0 0 16px;
        color: #111827;
        font-weight: 600;
      }

      .process-window__card {
        background: #fff;
        border-radius: 10px;
        padding: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        margin-bottom: 14px;
      }

      .process-window__meta {
        margin: 6px 0;
        color: #4b5563;
      }

      .process-window__section-title {
        margin: 16px 0 10px;
        font-size: 18px;
      }

      .process-window__queue {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .process-window__empty {
        color: #6b7280;
        font-style: italic;
      }

      .process-window__refresh {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s ease;
      }

      .process-window__refresh:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .process-window__refresh:hover:not(:disabled) {
        background: #1d4ed8;
      }

      .process-window__header {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 18px;
        color: #2563eb;
        text-decoration: none;
        font-weight: 600;
      }

      .back-link span {
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <a href="/" class="back-link"><span>←</span> Vissza a főoldalra</a>
    <div class="process-window">
      <div class="process-window__header">
        <div>
          <h1>Feldolgozási állapot</h1>
          <p class="process-window__subtitle">Ellenőrizd az aktuális és sorban álló fájlokat.</p>
        </div>
        <button id="refreshProcessing" class="process-window__refresh" type="button">Frissítés</button>
      </div>
      <p id="processingStatusText" class="process-window__status">Állapot betöltése folyamatban...</p>
      <div>
        <h2 class="process-window__section-title">Aktív feldolgozás</h2>
        <div id="currentProcessing" class="process-window__card"></div>
      </div>
      <div>
        <h2 class="process-window__section-title">Várakozó fájlok</h2>
        <p id="processingQueueCount" class="process-window__status"></p>
        <ul id="processingQueue" class="process-window__queue"></ul>
      </div>
    </div>

    <script>
      const SESSION_KEYS = {
        token: "token",
        username: "username",
        isAdmin: "isAdmin",
        canTransfer: "canTransfer",
        canViewClips: "canViewClips",
        profilePictureFilename: "profilePictureFilename",
      };

      function getStoredToken() {
        return localStorage.getItem(SESSION_KEYS.token);
      }

      function isUserLoggedIn() {
        return !!getStoredToken();
      }

      function buildAuthHeaders() {
        const token = getStoredToken();
        if (!token) {
          return {};
        }
        return {
          Authorization: `Bearer ${token}`,
        };
      }

      function formatHungarianDate(value) {
        const parsedDate = value ? new Date(value) : null;
        if (!parsedDate || Number.isNaN(parsedDate.getTime())) {
          return "Ismeretlen időpont";
        }

        return parsedDate.toLocaleString("hu-HU", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      async function fetchProcessingStatus() {
        const response = await fetch("/api/admin/processing-status", { headers: buildAuthHeaders() });
        const data = await response.json().catch(() => null);

        if (!response.ok) {
          const message = data && data.message ? data.message : "Nem sikerült lekérdezni a feldolgozási állapotot.";
          throw new Error(message);
        }

        return {
          isProcessing: Boolean(data?.isProcessing),
          currentTask: data?.currentTask || null,
          pending: Array.isArray(data?.pending) ? data.pending : [],
        };
      }

      function renderProcessingCard(container, item, titlePrefix) {
        if (!container) {
          return;
        }

        container.innerHTML = "";

        if (!item) {
          const empty = document.createElement("p");
          empty.className = "process-window__empty";
          empty.textContent = "Jelenleg nincs aktív feldolgozási feladat.";
          container.appendChild(empty);
          return;
        }

        const title = document.createElement("h3");
        title.textContent = `${titlePrefix || "Fájl"}: ${item.original_name || item.filename || "Ismeretlen"}`;
        container.appendChild(title);

        const fileMeta = document.createElement("p");
        fileMeta.className = "process-window__meta";
        fileMeta.textContent = `Elérési út: ${item.filename || "-"}`;
        container.appendChild(fileMeta);

        const timeMeta = document.createElement("p");
        timeMeta.className = "process-window__meta";
        timeMeta.textContent = `Feltöltve: ${formatHungarianDate(item.uploaded_at)}`;
        container.appendChild(timeMeta);

        const statusMeta = document.createElement("p");
        statusMeta.className = "process-window__meta";
        statusMeta.textContent = `Státusz: ${item.processing_status || "ismeretlen"}`;
        container.appendChild(statusMeta);
      }

      function renderQueue(doc, queueListEl, items) {
        if (!queueListEl) {
          return;
        }

        queueListEl.innerHTML = "";

        if (!items || !items.length) {
          const empty = doc.createElement("li");
          empty.className = "process-window__empty";
          empty.textContent = "Nincs várakozó fájl a sorban.";
          queueListEl.appendChild(empty);
          return;
        }

        items.forEach((item, index) => {
          const li = doc.createElement("li");
          li.className = "process-window__card";
          renderProcessingCard(li, item, `#${index + 1}`);
          queueListEl.appendChild(li);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const statusEl = document.getElementById("processingStatusText");
        const currentTaskEl = document.getElementById("currentProcessing");
        const queueListEl = document.getElementById("processingQueue");
        const queueCountEl = document.getElementById("processingQueueCount");
        const refreshBtn = document.getElementById("refreshProcessing");

        if (!isUserLoggedIn()) {
          alert("Nincs érvényes hitelesítés. Jelentkezz be, hogy lásd a feldolgozási állapotot.");
          window.location.href = "/";
          return;
        }

        const loadStatus = async () => {
          if (statusEl) {
            statusEl.textContent = "Állapot betöltése folyamatban...";
          }
          renderProcessingCard(currentTaskEl, null);
          renderQueue(document, queueListEl, []);
          if (queueCountEl) {
            queueCountEl.textContent = "";
          }

          try {
            const data = await fetchProcessingStatus();
            if (statusEl) {
              statusEl.textContent = data.isProcessing
                ? "Egy fájl feldolgozása folyamatban."
                : "Jelenleg nincs aktív feldolgozás.";
            }

            if (queueCountEl) {
              queueCountEl.textContent = `Várakozó fájlok: ${data.pending.length}`;
            }

            renderProcessingCard(currentTaskEl, data.currentTask, "Aktív feldolgozás");
            renderQueue(document, queueListEl, data.pending);
          } catch (error) {
            console.error("Feldolgozási állapot lekérdezési hiba:", error);
            if (statusEl) {
              statusEl.textContent = error.message || "Nem sikerült lekérdezni a feldolgozási állapotot.";
            }
          }
        };

        if (refreshBtn) {
          refreshBtn.addEventListener("click", () => {
            loadStatus();
          });
        }

        loadStatus();
      });
    </script>
  </body>
</html>
