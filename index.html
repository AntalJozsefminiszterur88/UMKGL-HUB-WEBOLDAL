<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <title>UMGKL HUB</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="program_icons/oldal_logo.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Condensed:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="HOI4-Porgonc/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
      :root {
        --bg-primary: #36393f; /* Discord dark gray */
        --bg-secondary: #2f3136; /* Slightly darker for header */
        --text-primary: #dcddde; /* Light gray text */
        --accent: #7289da; /* Discord blurple */
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        padding: 0; /* Remove outer spacing so header and footer reach page edges */
      }

      header {
        background: var(--bg-secondary);
        padding-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        width: 100%;
      }

      .banner {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        display: block;
      }

      h1 {
        margin-top: 1rem;
        font-size: 2.5rem;
        color: var(--accent);
      }

      nav {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
        border-top: 1px solid #202225;
        border-bottom: 1px solid #202225;
        padding: 0.5rem 0;
      }

      nav a {
        color: var(--text-primary);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: background 0.2s;
      }

      nav a:hover,
      nav a.active {
        background: var(--accent);
        color: #fff;
      }

      main {
        flex: 1;
        padding: 2rem;
      }

      section {
        display: none;
        max-width: 800px;
        margin: 0 auto;
        text-align: left;
        line-height: 1.6;
      }

      section.active {
        display: block;
      }

      /* A HOI4 sorsol√≥ szekci√≥n√°l ne legyen sz√©less√©gkorl√°t, hogy a n√©gy doboz egym√°s mellett
         maradjon */
      #sorsolas {
        max-width: none;
      }

      /* Szavaz√°s st√≠lusok */
      #pollCreator,
      #pollDisplay {
        background: #2c2f33;
        padding: 1rem;
        border: 1px solid #202225;
        border-radius: 4px;
        margin-bottom: 1rem;
      }
      #pollCreator input[type="text"] {
        width: 100%;
        padding: 0.5rem;
        margin: 0.25rem 0;
        color: var(--text-primary);
        background: #1e2124;
        border: 1px solid #202225;
        border-radius: 4px;
      }
      #pollCreator button,
      #pollDisplay button,
      #newPollBtn {
        background: var(--accent);
        border: none;
        padding: 0.5rem 1rem;
        margin-top: 0.5rem;
        color: #fff;
        cursor: pointer;
        border-radius: 4px;
        display: inline-block;
      }
      #pollDisplay button.option {
        display: block;
        margin: 0.25rem 0;
        width: 100%;
        text-align: left;
      }
      #newPollBtn {
        margin-bottom: 1rem;
      }

        footer {
          width: 100%;
          padding: 1rem;
          font-size: 0.875rem;
          background: rgb(47, 49, 54);
        }
      /* Programok szekci√≥ st√≠lusai */
      #programok .program-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        justify-items: center;
      }

      #programok .box {
        width: 100%;
        max-width: 250px;
        text-align: center;
      }

      .program-icon {
        width: 120px;
        height: 120px;
        object-fit: contain;
        margin-bottom: 10px;
      }

      .download-btn {
        margin-top: 10px;
        padding: 0.5rem 1rem;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        cursor: not-allowed;
      }

      .user-table {
        width: 100%;
        max-width: 600px;
        margin-top: 1rem;
        border-collapse: collapse;
      }

      .user-table th,
      .user-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #4f545c;
      }

      .user-table th {
        background-color: var(--bg-secondary);
      }

      .user-table tbody tr:hover {
        background-color: #3c4046;
      }

      #savePermissionsBtn {
        margin-top: 1.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }

      #savePermissionsBtn:hover:not(:disabled) {
        background: #5b6dad;
      }

      #savePermissionsBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Auth buttons */
      .auth-buttons {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .auth-buttons__group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .auth-buttons button,
      .auth-buttons a {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        margin-left: 0.25rem;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
      }

      /* Login modal */
      #loginModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
      }

      #loginModal .modal-content {
        background: var(--bg-secondary);
        padding: 1rem;
        border-radius: 4px;
        width: 300px;
      }

      #loginModal input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border: 1px solid #202225;
        border-radius: 4px;
        background: #1e2124;
        color: var(--text-primary);
      }

      #loginModal button {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <header>
      <!-- Placeholder banner image -->
      <img
        src="https://via.placeholder.com/1200x300?text=Banner+k√©p"
        alt="Banner"
        class="banner"
      />
      <h1>UMGKL HUB</h1>
      <nav>
        <a href="#home" data-section="home" class="active">F≈ëoldal</a>
        <a href="#klipek" data-section="klipek">Klippek</a>
        <a href="#sorsolas" data-section="sorsolas">Hoi4 Sorsol√°s</a>
        <a href="#szavazas" data-section="szavazas">Szavaz√°s</a>
        <a href="#programok" data-section="programok">Programok</a>
        <a href="#admin" data-section="admin" id="adminNavBtn" style="display: none;">Admin M√≥d</a>
      </nav>
      <div class="auth-buttons">
        <div id="authLoggedOut" class="auth-buttons__group">
          <button id="loginBtn" type="button">Bejelentkez√©s</button>
          <a href="register.html" id="registerBtn">Regisztr√°ci√≥</a>
        </div>
        <div id="authLoggedIn" class="auth-buttons__group" style="display: none">
          <span id="userGreeting"></span>
          <button id="logoutBtn" type="button">Kijelentkez√©s</button>
        </div>
      </div>
    </header>

    <div id="loginModal">
      <div class="modal-content">
        <span id="closeLogin" style="float: right; cursor: pointer">&times;</span>
        <h2>Bejelentkez√©s</h2>
        <form id="loginForm">
          <input type="text" id="loginUser" placeholder="Felhaszn√°l√≥n√©v" required />
          <input type="password" id="loginPass" placeholder="Jelsz√≥" required />
          <button type="submit">Bel√©p√©s</button>
        </form>
      </div>
    </div>

    <main>
      <!-- F≈ëoldal -->
      <section id="home" class="active">
        <p>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec a diam
          lectus. Sed sit amet ipsum mauris. Maecenas congue ligula ac quam
          viverra nec consectetur ante hendrerit. Donec et mollis dolor.
          Praesent et diam eget libero egestas mattis sit amet vitae augue.
          Nam tincidunt congue enim, ut porta lorem lacinia consectetur.
          Donec ut libero sed arcu vehicula ultricies a non tortor. Lorem ipsum
          dolor sit amet, consectetur adipiscing elit.
        </p>
      </section>

      <section id="klipek">
        <h2>Leg√∫jabb Klipek</h2>
        <p>
          Hamarosan itt l√°thatod a k√∂z√∂ss√©g √°ltal felt√∂lt√∂tt legjobb
          klippeket!
        </p>
        <div id="video-grid-container">
          <!-- A vide√≥k dinamikusan ide fognak bet√∂lt≈ëdni a j√∂v≈ëben -->
        </div>
      </section>

      <!-- Hoi4 Sorsol√°s -->
      <section id="sorsolas">
        <h1>HOI4 Road to 56 ‚Äì Sorsol√≥</h1>

        <div class="controls-top">
          <button id="resetAllBtn">Teljes Sorsol√°s Vissza√°ll√≠t√°sa</button>
        </div>

        <div class="options-panel">
          <label for="balanceCountriesByStrength">
            <input type="checkbox" id="balanceCountriesByStrength" checked />
            Orsz√°gok er≈ëss√©galap√∫ kiegyens√∫lyoz√°sa a csapatok k√∂z√∂tt
          </label>
        </div>

        <div class="last-picked-display">
          Legut√≥bb: J√°t√©kos: <span id="lastPickedPlayer">-</span> | Orsz√°g:
          <span id="lastPickedCountry">-</span>
        </div>

        <div id="spinResultOverlay" class="spin-result-overlay">
          <div id="spunItemDisplay" class="spun-item-display">Kip√∂rgetve: -</div>
          <button id="nextSpinStepButton" class="next-spin-step-button">
            K√∂vetkez≈ë
          </button>
        </div>

        <div class="flex">
          <div class="box">
            <h2>
              J√°t√©kosok <span class="count-display" id="playerListCount">(0)</span>
            </h2>
            <input id="playerName" type="text" placeholder="N√©v" />
            <input
              id="playerSkill"
              type="number"
              placeholder="K√©pess√©g 1‚Äì10"
              min="1"
              max="10"
            />
            <button id="addPlayerBtn" onclick="handlePlayerSubmit()">
              Hozz√°ad√°s
            </button>
            <ul id="playersList"></ul>
          </div>

          <div class="box">
            <h2>
              Orsz√°gok <span class="count-display" id="countryListCount">(0)</span>
            </h2>
            <input id="countryName" type="text" placeholder="Orsz√°g neve" />
            <input
              id="countryStrength"
              type="number"
              placeholder="Er≈ëss√©g 1-10"
              min="1"
              max="10"
            />
            <button id="addCountryBtn" onclick="handleCountrySubmit()">
              Hozz√°ad√°s
            </button>
            <ul id="countriesList"></ul>
          </div>

          <div class="box">
            <h2>Csapatok</h2>
            <div id="teamWheelContainer" class="wheel-container">
              <div class="pointer">‚óÑ</div>
              <canvas id="teamWheel" width="250" height="250"></canvas>
            </div>
            <button id="spinTeamBtn">Csapat oszt√°s / Forgat√°s</button>
            <h3>
              Csapat 1 j√°t√©kosok
              <span class="count-display" id="team1PlayerCount">(0)</span>
            </h3>
            <ul id="playerBasket1" class="player-basket"></ul>
            <h3>
              Csapat 2 j√°t√©kosok
              <span class="count-display" id="team2PlayerCount">(0)</span>
            </h3>
            <ul id="playerBasket2" class="player-basket"></ul>
          </div>

          <div class="box">
            <h2>
              Orsz√°gok <span class="count-display" id="countryBoxCount">(0)</span>
            </h2>
            <div id="countryWheelContainer" class="wheel-container">
              <div class="pointer">‚óÑ</div>
              <canvas id="countryWheel" width="250" height="250"></canvas>
            </div>
            <button id="spinCountryBtn">Orsz√°g oszt√°s / Forgat√°s</button>

            <div id="countryGridsContainer">
              <div class="team-grid-wrapper" id="team1CountryGridWrapper">
                <h3>
                  Csapat 1 orsz√°gok
                  <span class="count-display" id="team1CountryCount">(0/9)</span>
                  <button
                    class="grid-zoom-btn"
                    data-targetwrapper="team1CountryGridWrapper"
                    title="Nagy√≠t√°s/Kicsiny√≠t√©s"
                  >
                    üîç
                  </button>
                </h3>
                <div id="countrySlots1" class="basket-grid"></div>
              </div>
              <div class="team-grid-wrapper" id="team2CountryGridWrapper">
                <h3>
                  Csapat 2 orsz√°gok
                  <span class="count-display" id="team2CountryCount">(0/9)</span>
                  <button
                    class="grid-zoom-btn"
                    data-targetwrapper="team2CountryGridWrapper"
                    title="Nagy√≠t√°s/Kicsiny√≠t√©s"
                  >
                    üîç
                  </button>
                </h3>
                <div id="countrySlots2" class="basket-grid"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Szavaz√°s -->
      <section id="szavazas">
        <div id="pollCreator">
          <form id="createPollForm">
            <input
              id="questionInput"
              type="text"
              placeholder="K√©rd√©s"
              required
            />
            <div id="optionsContainer"></div>
            <button type="button" id="addOptionBtn">√öj v√°laszlehet≈ës√©g</button>
            <button type="submit">Szavaz√°s l√©trehoz√°sa</button>
          </form>
        </div>
        <div id="pollDisplay" style="display: none"></div>
        <button id="newPollBtn" style="display: none">√öj szavaz√°s</button>
      </section>

<!-- Programok -->
      <section id="programok">
        <div class="flex program-grid">
          <div class="box">
            <img src="program_icons/foto-apparatus.png" alt="FOTO-Appar√°tus ikon" class="program-icon" />
            <h3>FOTO-Appar√°tus</h3>
            <p>Lefot√≥zza a fitym√°dat bizonyos id≈ëk√∂z√∂nk√©nt</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 2</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 3</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 4</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
        </div>
      </section>

      <section id="admin">
        <h2>Felhaszn√°l√≥k Kezel√©se</h2>
        <div id="userListContainer"></div>
        <button id="savePermissionsBtn">V√°ltoztat√°sok Ment√©se</button>
      </section>
    </main>

    <footer>
      <p>¬© 2025 UMGKL HUB</p>
    </footer>

    <script>
      // Egyszer≈± kliensoldali navig√°ci√≥ a szekci√≥k k√∂z√∂tt
      document.querySelectorAll("nav a").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const target = link.dataset.section;

          // Akt√≠v nav elem friss√≠t√©se
          document
            .querySelectorAll("nav a")
            .forEach((a) => a.classList.remove("active"));
          link.classList.add("active");

          // Szekci√≥k v√°lt√°sa
          document.querySelectorAll("main section").forEach((sec) => {
            if (sec.id === target) {
              sec.classList.add("active");
            } else {
              sec.classList.remove("active");
            }
          });

          // URL hash friss√≠t√©se (opcion√°lis)
          history.pushState(null, "", `#${target}`);
        });
      });

      // Oldal bet√∂lt√©sekor a hash alapj√°n nyitjuk meg a megfelel≈ë szekci√≥t
      window.addEventListener("load", () => {
        const hash = location.hash.replace("#", "") || "home";
        const link = document.querySelector(`nav a[data-section="${hash}"]`);
        if (link) link.click();
      });
    </script>

    <script>
      function addOptionField() {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "V√°laszlehet≈ës√©g";
        input.className = "poll-option";
        document.getElementById("optionsContainer").appendChild(input);
      }

      document.getElementById("addOptionBtn").addEventListener("click", addOptionField);

      document.getElementById("createPollForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const question = document.getElementById("questionInput").value.trim();
        const optionInputs = document.querySelectorAll(".poll-option");
        const options = Array.from(optionInputs)
          .map((i) => i.value.trim())
          .filter((v) => v);
        if (!question || options.length < 2) {
          alert("Adj meg k√©rd√©st √©s legal√°bb 2 v√°laszt!");
          return;
        }
        window.pollData = { question, options, votes: Array(options.length).fill(0) };
        renderPoll();
      });

      function renderPoll() {
        document.getElementById("createPollForm").style.display = "none";
        const disp = document.getElementById("pollDisplay");
        disp.innerHTML = `<h3>${window.pollData.question}</h3>`;
        window.pollData.options.forEach((opt, i) => {
          const btn = document.createElement("button");
          btn.className = "option";
          btn.textContent = `${opt} (0)`;
          btn.addEventListener("click", () => vote(i, btn));
          disp.appendChild(btn);
        });
        disp.style.display = "block";
        document.getElementById("newPollBtn").style.display = "inline-block";
      }

      function vote(idx, btn) {
        window.pollData.votes[idx]++;
        btn.textContent = `${window.pollData.options[idx]} (${window.pollData.votes[idx]})`;
      }

      document.getElementById("newPollBtn").addEventListener("click", function () {
        window.pollData = null;
        document.getElementById("pollDisplay").innerHTML = "";
        document.getElementById("pollDisplay").style.display = "none";
        document.getElementById("createPollForm").style.display = "block";
        document.getElementById("optionsContainer").innerHTML = "";
        for (let i = 0; i < 2; i++) addOptionField();
        document.getElementById("questionInput").value = "";
        this.style.display = "none";
      });

    window.addEventListener("load", () => {
      for (let i = 0; i < 2; i++) addOptionField();
    });
  </script>

  <script>
    const loginModal = document.getElementById("loginModal");
    const closeLogin = document.getElementById("closeLogin");
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authLoggedOut = document.getElementById("authLoggedOut");
    const authLoggedIn = document.getElementById("authLoggedIn");
    const userGreeting = document.getElementById("userGreeting");
    const adminNavBtn = document.getElementById("adminNavBtn");
    const userListContainer = document.getElementById("userListContainer");
    const savePermissionsBtn = document.getElementById("savePermissionsBtn");

    if (savePermissionsBtn) {
      savePermissionsBtn.disabled = true;
    }

    function openLoginModal() {
      if (loginForm) {
        loginForm.reset();
      }
      loginModal.style.display = "flex";
    }

    function updateAdminNavVisibility() {
      if (!adminNavBtn) return;

      const isAdmin = localStorage.getItem("isAdmin") === "true";
      adminNavBtn.style.display = isAdmin ? "inline-block" : "none";

      if (!isAdmin) {
        const adminSection = document.getElementById("admin");
        if (adminSection && adminSection.classList.contains("active")) {
          const homeLink = document.querySelector('nav a[data-section="home"]');
          if (homeLink) {
            homeLink.click();
          } else {
            adminSection.classList.remove("active");
          }
        }
        if (userListContainer) {
          userListContainer.innerHTML = "";
        }
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
      }
    }

    function updateUIForLoggedIn(username) {
      if (userGreeting) {
        userGreeting.textContent = `Szia, ${username}!`;
      }
      if (authLoggedOut) {
        authLoggedOut.style.display = "none";
      }
      if (authLoggedIn) {
        authLoggedIn.style.display = "flex";
      }

      updateAdminNavVisibility();
    }

    function updateUIForLoggedOut() {
      if (authLoggedOut) {
        authLoggedOut.style.display = "flex";
      }
      if (authLoggedIn) {
        authLoggedIn.style.display = "none";
      }
      if (userGreeting) {
        userGreeting.textContent = "";
      }
      updateAdminNavVisibility();
    }

    if (loginBtn) {
      loginBtn.addEventListener("click", openLoginModal);
    }

    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        localStorage.removeItem("isAdmin");
        updateUIForLoggedOut();
        alert("Sikeresen kijelentkezt√©l.");
      });
    }

    function renderUserList(users) {
      if (!userListContainer) {
        return;
      }

      userListContainer.innerHTML = "";

      if (!Array.isArray(users) || users.length === 0) {
        userListContainer.textContent = "Nincs megjelen√≠thet≈ë felhaszn√°l√≥.";
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
        return;
      }

      const table = document.createElement("table");
      table.className = "user-table";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Felhaszn√°l√≥n√©v</th>
          <th>Felt√∂lt√©si Jogosults√°g</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      users.forEach((user) => {
        const row = document.createElement("tr");
        row.dataset.userId = user.id;

        const usernameCell = document.createElement("td");
        usernameCell.textContent = user.username;
        row.appendChild(usernameCell);

        const permissionCell = document.createElement("td");
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = Number(user.can_upload) === 1;
        label.appendChild(checkbox);
        label.append(" Felt√∂lthet");
        permissionCell.appendChild(label);
        row.appendChild(permissionCell);

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      userListContainer.appendChild(table);

      if (savePermissionsBtn) {
        savePermissionsBtn.disabled = false;
      }
    }

    async function loadAdminPanel() {
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Nincs √©rv√©nyes hiteles√≠t√©s.");
        return;
      }

      try {
        const response = await fetch("/api/users", {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json().catch(() => null);

        if (!response.ok) {
          const message = data && data.message ? data.message : "Nem siker√ºlt bet√∂lteni a felhaszn√°l√≥kat.";
          throw new Error(message);
        }

        renderUserList(Array.isArray(data) ? data : []);
      } catch (error) {
        console.error("Admin panel bet√∂lt√©si hiba:", error);
        alert(error.message || "Nem siker√ºlt bet√∂lteni az admin panel adatait.");
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
      }
    }

    if (savePermissionsBtn) {
      const originalButtonText = savePermissionsBtn.textContent;

      savePermissionsBtn.addEventListener("click", async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Nincs √©rv√©nyes hiteles√≠t√©s.");
          return;
        }

        if (!userListContainer) {
          alert("Nem tal√°lhat√≥ a felhaszn√°l√≥i lista.");
          return;
        }

        const tableBody = userListContainer.querySelector("tbody");
        if (!tableBody) {
          alert("Nincs ment√©sre v√°r√≥ adat.");
          return;
        }

        const rows = Array.from(tableBody.querySelectorAll("tr"));
        const permissionsToUpdate = rows
          .map((row) => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            const userIdAttr = row.dataset.userId;

            if (!checkbox || !userIdAttr) {
              return null;
            }

            const userId = Number.parseInt(userIdAttr, 10);
            if (Number.isNaN(userId)) {
              return null;
            }

            return {
              userId,
              canUpload: checkbox.checked,
            };
          })
          .filter(Boolean);

        if (permissionsToUpdate.length === 0) {
          alert("Nincs ment√©sre v√°r√≥ adat.");
          return;
        }

        savePermissionsBtn.disabled = true;
        savePermissionsBtn.textContent = "Ment√©s folyamatban...";

        try {
          const response = await fetch("/api/users/permissions/batch-update", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(permissionsToUpdate),
          });

          const result = await response.json().catch(() => null);

          if (!response.ok) {
            const message = result && result.message ? result.message : "Nem siker√ºlt menteni a jogosults√°gokat.";
            throw new Error(message);
          }

          alert((result && result.message) || "Jogosults√°gok sikeresen friss√≠tve.");
          await loadAdminPanel();
        } catch (error) {
          console.error("Jogosults√°g ment√©si hiba:", error);
          alert(error.message || "Nem siker√ºlt menteni a jogosults√°gokat.");
        } finally {
          savePermissionsBtn.disabled = false;
          savePermissionsBtn.textContent = originalButtonText;
        }
      });
    }

    closeLogin.addEventListener("click", () => {
      loginModal.style.display = "none";
    });

    if (adminNavBtn) {
      adminNavBtn.addEventListener("click", loadAdminPanel);
    }

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("loginUser").value;
      const password = document.getElementById("loginPass").value;

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await res.json();

        if (res.ok) {
          localStorage.setItem("token", data.token);
          localStorage.setItem("username", data.username);
          localStorage.setItem("isAdmin", data.isAdmin ? "true" : "false");
          updateUIForLoggedIn(data.username);
          loginModal.style.display = "none";
          alert(data.message || "Sikeres bejelentkez√©s.");
        } else {
          alert(data.message || "Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥.");
        }
      } catch (error) {
        console.error("Bejelentkez√©si hiba:", error);
        alert("Hiba t√∂rt√©nt a bejelentkez√©s sor√°n. Pr√≥b√°ld meg k√©s≈ëbb.");
      }
    });

    window.addEventListener("load", () => {
      const storedToken = localStorage.getItem("token");
      const storedUsername = localStorage.getItem("username");

      if (storedToken && storedUsername) {
        updateUIForLoggedIn(storedUsername);
      } else {
        localStorage.removeItem("isAdmin");
        updateUIForLoggedOut();
      }
    });
  </script>

  <script src="HOI4-Porgonc/script.js"></script>
  </body>
</html>
