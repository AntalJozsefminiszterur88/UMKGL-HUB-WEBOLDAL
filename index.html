<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <title>UMGKL HUB</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="program_icons/oldal_logo.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Condensed:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="HOI4-Porgonc/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
      :root {
        --bg-primary: #36393f; /* Discord dark gray */
        --bg-secondary: #2f3136; /* Slightly darker for header */
        --text-primary: #dcddde; /* Light gray text */
        --accent: #7289da; /* Discord blurple */
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        padding: 0; /* Remove outer spacing so header and footer reach page edges */
      }

      header {
        background: var(--bg-secondary);
        padding-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        width: 100%;
      }

      .banner {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        display: block;
      }

      h1 {
        margin-top: 1rem;
        font-size: 2.5rem;
        color: var(--accent);
      }

      nav {
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
        border-top: 1px solid #202225;
        border-bottom: 1px solid #202225;
        padding: 0.5rem 0;
      }

      nav a {
        color: var(--text-primary);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: background 0.2s;
      }

      nav a:hover,
      nav a.active {
        background: var(--accent);
        color: #fff;
      }

      main {
        flex: 1;
        padding: 2rem;
      }

      section {
        display: none;
        max-width: 800px;
        margin: 0 auto;
        text-align: left;
        line-height: 1.6;
      }

      section.active {
        display: block;
      }

      #video-grid-container {
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .video-card {
        background: #2c2f33;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .video-card video {
        width: 100%;
        border-radius: 6px;
        background: #000;
      }

      .video-card p {
        margin: 0;
        font-weight: 500;
      }

      /* A HOI4 sorsol√≥ szekci√≥n√°l ne legyen sz√©less√©gkorl√°t, hogy a n√©gy doboz egym√°s mellett
         maradjon */
      #sorsolas {
        max-width: none;
      }

      /* Szavaz√°s st√≠lusok */
      #szavazas {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .poll-card {
        background: #2c2f33;
        padding: 1rem;
        border: 1px solid #202225;
        border-radius: 6px;
      }

      .poll-card h3 {
        margin-top: 0;
        margin-bottom: 0.75rem;
      }

      .poll-hint {
        color: #b9bbbe;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
      }

      .poll-text-input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        background: #1e2124;
        border: 1px solid #202225;
        border-radius: 4px;
      }

      .poll-options-inputs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .poll-option-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .poll-option-input {
        flex: 1;
        padding: 0.5rem;
        color: var(--text-primary);
        background: #1e2124;
        border: 1px solid #202225;
        border-radius: 4px;
      }

      .poll-option-remove {
        background: #202225;
        border: none;
        color: #fff;
        border-radius: 4px;
        padding: 0.45rem 0.6rem;
        cursor: pointer;
      }

      .poll-option-remove:hover:not(:disabled) {
        background: #f04747;
      }

      .poll-option-remove:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .poll-creator-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
      }

      .poll-button {
        background: var(--accent);
        border: none;
        padding: 0.5rem 1rem;
        color: #fff;
        cursor: pointer;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        font-weight: 600;
      }

      .poll-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .poll-secondary-btn {
        background: #3a3d42;
      }

      .poll-secondary-btn:hover:not(:disabled) {
        background: #484b51;
      }

      .poll-primary-btn:hover:not(:disabled),
      .poll-vote-btn:hover:not(:disabled) {
        filter: brightness(1.05);
      }

      .poll-close-btn {
        background: #f04747;
      }

      .poll-close-btn:hover:not(:disabled) {
        background: #ff5c5c;
      }

      .poll-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .poll-card-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .poll-status {
        background: #1e2124;
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #b9bbbe;
      }

      .poll-status--active {
        color: #57f287;
      }

      .poll-status--closed {
        color: #f04747;
      }

      .poll-meta {
        font-size: 0.85rem;
        color: #b9bbbe;
      }

      .poll-options-results {
        margin-top: 0.75rem;
      }

      .poll-option-result {
        padding: 0.75rem 0;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }

      .poll-option-result:first-of-type {
        border-top: none;
      }

      .poll-option-result--selected {
        border-left: 3px solid var(--accent);
        padding-left: 0.75rem;
        background: rgba(114, 137, 218, 0.08);
      }

      .poll-option-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .poll-option-label {
        flex: 1 1 auto;
        font-weight: 600;
      }

      .poll-option-count {
        font-size: 0.85rem;
        color: #b9bbbe;
      }

      .poll-badge {
        background: rgba(114, 137, 218, 0.2);
        color: var(--accent);
        border-radius: 999px;
        padding: 0.2rem 0.6rem;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .poll-result-bar {
        width: 100%;
        height: 0.75rem;
        background: #1e2124;
        border: 1px solid #202225;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 0.5rem;
      }

      .poll-result-bar-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), #5865f2);
        transition: width 0.3s ease;
      }

      .poll-option-result--selected .poll-result-bar-fill {
        background: linear-gradient(90deg, #57f287, var(--accent));
      }

      .poll-voters {
        margin-top: 0.4rem;
        font-size: 0.8rem;
        color: #b9bbbe;
      }

      .poll-total-votes {
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: #b9bbbe;
      }

      .poll-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .poll-empty {
        background: #2c2f33;
        padding: 1rem;
        border: 1px solid #202225;
        border-radius: 6px;
        text-align: center;
        color: #b9bbbe;
      }

        footer {
          width: 100%;
          padding: 1rem;
          font-size: 0.875rem;
          background: rgb(47, 49, 54);
        }
      /* Programok szekci√≥ st√≠lusai */
      #programok .program-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        justify-items: center;
      }

      #programok .box {
        width: 100%;
        max-width: 250px;
        text-align: center;
      }

      .program-icon {
        width: 120px;
        height: 120px;
        object-fit: contain;
        margin-bottom: 10px;
      }

      .download-btn {
        margin-top: 10px;
        padding: 0.5rem 1rem;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        text-decoration: none;
        cursor: not-allowed;
      }

      .user-table {
        width: 100%;
        max-width: 600px;
        margin-top: 1rem;
        border-collapse: collapse;
      }

      .user-table th,
      .user-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #4f545c;
      }

      .user-table input[type="number"] {
        width: 100%;
        max-width: 120px;
        padding: 0.4rem;
        border-radius: 4px;
        border: 1px solid #202225;
        background: #1e2124;
        color: var(--text-primary);
      }

      .user-table th {
        background-color: var(--bg-secondary);
      }

      .user-table tbody tr:hover {
        background-color: #3c4046;
      }

      .permission-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .admin-description {
        margin-top: 0.5rem;
        max-width: 600px;
      }

      #savePermissionsBtn {
        margin-top: 1.5rem;
        padding: 0.75rem 1.5rem;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }

      #savePermissionsBtn:hover:not(:disabled) {
        background: #5b6dad;
      }

      #savePermissionsBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Auth buttons */
      .auth-buttons {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .auth-buttons__group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .auth-buttons button,
      .auth-buttons a {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        margin-left: 0.25rem;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        padding: 1rem;
      }

      .upload-modal-content {
        background: var(--bg-secondary);
        padding: 1.5rem;
        border-radius: 8px;
        width: 100%;
        max-width: 500px;
        position: relative;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
      }

      .upload-modal-content h3 {
        margin-bottom: 1rem;
      }

      .close-btn {
        position: absolute;
        top: 0.75rem;
        right: 1rem;
        font-size: 1.5rem;
        cursor: pointer;
      }

      #drop-zone {
        border: 2px dashed var(--accent);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        background: rgba(114, 137, 218, 0.1);
        transition: background 0.2s, border-color 0.2s;
        margin-bottom: 1rem;
      }

      #drop-zone.drag-over {
        background: rgba(114, 137, 218, 0.2);
        border-color: #99a9e6;
      }

      #drop-zone p {
        margin-bottom: 0.5rem;
      }

      #uploadBtn {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        width: 100%;
      }

      #uploadBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .upload-status {
        margin-top: 0.75rem;
        min-height: 1.25rem;
      }

      /* Login modal */
      #loginModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
      }

      #loginModal .modal-content {
        background: var(--bg-secondary);
        padding: 1rem;
        border-radius: 4px;
        width: 300px;
      }

      #loginModal input {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border: 1px solid #202225;
        border-radius: 4px;
        background: #1e2124;
        color: var(--text-primary);
      }

      #loginModal button {
        width: 100%;
      }

      .feedback-modal {
        position: fixed;
        inset: 0;
        display: none;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1100;
        padding: 1rem;
      }

      .feedback-modal__content {
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 1.5rem;
        border-radius: 8px;
        width: min(90%, 360px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
        position: relative;
        text-align: center;
      }

      .feedback-modal__title {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
      }

      .feedback-modal__message {
        margin-bottom: 1.25rem;
      }

      .feedback-modal__close {
        position: absolute;
        top: 0.5rem;
        right: 0.75rem;
        background: none;
        border: none;
        color: inherit;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .feedback-modal__actions button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <!-- Placeholder banner image -->
      <img
        src="https://via.placeholder.com/1200x300?text=Banner+k√©p"
        alt="Banner"
        class="banner"
      />
      <h1>UMGKL HUB</h1>
      <nav>
        <a href="#home" data-section="home" class="active">F≈ëoldal</a>
        <a href="#klipek" data-section="klipek">Klippek</a>
        <a href="#sorsolas" data-section="sorsolas">Hoi4 Sorsol√°s</a>
        <a href="#szavazas" data-section="szavazas">Szavaz√°s</a>
        <a href="#programok" data-section="programok">Programok</a>
        <a href="#admin" data-section="admin" id="adminNavBtn" style="display: none;">Admin M√≥d</a>
      </nav>
      <div class="auth-buttons">
        <div id="authLoggedOut" class="auth-buttons__group">
          <button id="loginBtn" type="button">Bejelentkez√©s</button>
          <a href="register.html" id="registerBtn">Regisztr√°ci√≥</a>
        </div>
        <div id="authLoggedIn" class="auth-buttons__group" style="display: none">
          <span id="userGreeting"></span>
          <button id="logoutBtn" type="button">Kijelentkez√©s</button>
        </div>
      </div>
    </header>

    <div id="loginModal">
      <div class="modal-content">
        <span id="closeLogin" style="float: right; cursor: pointer">&times;</span>
        <h2>Bejelentkez√©s</h2>
        <form id="loginForm">
          <input type="text" id="loginUser" placeholder="Felhaszn√°l√≥n√©v" required />
          <input type="password" id="loginPass" placeholder="Jelsz√≥" required />
          <button type="submit">Bel√©p√©s</button>
        </form>
      </div>
    </div>

    <div id="loginSuccessModal" class="feedback-modal" role="dialog" aria-modal="true" aria-labelledby="loginSuccessTitle" style="display: none">
      <div class="feedback-modal__content">
        <button id="loginSuccessClose" class="feedback-modal__close" type="button" aria-label="Bez√°r√°s">&times;</button>
        <h3 id="loginSuccessTitle" class="feedback-modal__title">Sikeres bejelentkez√©s</h3>
        <p id="loginSuccessMessage" class="feedback-modal__message"></p>
        <div class="feedback-modal__actions">
          <button id="loginSuccessOk" type="button">OK</button>
        </div>
      </div>
    </div>

    <main>
      <!-- F≈ëoldal -->
      <section id="home" class="active">
        <p>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec a diam
          lectus. Sed sit amet ipsum mauris. Maecenas congue ligula ac quam
          viverra nec consectetur ante hendrerit. Donec et mollis dolor.
          Praesent et diam eget libero egestas mattis sit amet vitae augue.
          Nam tincidunt congue enim, ut porta lorem lacinia consectetur.
          Donec ut libero sed arcu vehicula ultricies a non tortor. Lorem ipsum
          dolor sit amet, consectetur adipiscing elit.
        </p>
      </section>

      <section id="klipek">
        <h2>Leg√∫jabb Klipek</h2>
        <p>
          Hamarosan itt l√°thatod a k√∂z√∂ss√©g √°ltal felt√∂lt√∂tt legjobb
          klippeket!
        </p>
        <button id="showUploadModalBtn" style="float: right;">Felt√∂lt√©s</button>
        <div style="clear: both;"></div>
        <div id="video-grid-container">
          <!-- A vide√≥k dinamikusan ide fognak bet√∂lt≈ëdni a j√∂v≈ëben -->
        </div>
        <div id="uploadModal" class="modal-overlay" style="display: none;">
          <div class="upload-modal-content">
            <span class="close-btn" id="closeUploadModal">&times;</span>
            <h3>Vide√≥ felt√∂lt√©se</h3>
            <div id="drop-zone">
              <p>H√∫zd ide a vide√≥dat vagy kattints a tall√≥z√°shoz</p>
              <p id="selectedFileName">Nincs kiv√°lasztott f√°jl.</p>
            </div>
            <input type="file" id="fileInput" accept="video/*" style="display: none;" />
            <button id="uploadBtn" disabled>Felt√∂lt√©s</button>
            <p id="uploadStatus" class="upload-status"></p>
          </div>
        </div>
      </section>

      <!-- Hoi4 Sorsol√°s -->
      <section id="sorsolas">
        <h1>HOI4 Road to 56 ‚Äì Sorsol√≥</h1>

        <div class="controls-top">
          <button id="resetAllBtn">Teljes Sorsol√°s Vissza√°ll√≠t√°sa</button>
        </div>

        <div class="options-panel">
          <label for="balanceCountriesByStrength">
            <input type="checkbox" id="balanceCountriesByStrength" checked />
            Orsz√°gok er≈ëss√©galap√∫ kiegyens√∫lyoz√°sa a csapatok k√∂z√∂tt
          </label>
        </div>

        <div class="last-picked-display">
          Legut√≥bb: J√°t√©kos: <span id="lastPickedPlayer">-</span> | Orsz√°g:
          <span id="lastPickedCountry">-</span>
        </div>

        <div id="spinResultOverlay" class="spin-result-overlay">
          <div id="spunItemDisplay" class="spun-item-display">Kip√∂rgetve: -</div>
          <button id="nextSpinStepButton" class="next-spin-step-button">
            K√∂vetkez≈ë
          </button>
        </div>

        <div class="flex">
          <div class="box">
            <h2>
              J√°t√©kosok <span class="count-display" id="playerListCount">(0)</span>
            </h2>
            <input id="playerName" type="text" placeholder="N√©v" />
            <input
              id="playerSkill"
              type="number"
              placeholder="K√©pess√©g 1‚Äì10"
              min="1"
              max="10"
            />
            <button id="addPlayerBtn" onclick="handlePlayerSubmit()">
              Hozz√°ad√°s
            </button>
            <ul id="playersList"></ul>
          </div>

          <div class="box">
            <h2>
              Orsz√°gok <span class="count-display" id="countryListCount">(0)</span>
            </h2>
            <input id="countryName" type="text" placeholder="Orsz√°g neve" />
            <input
              id="countryStrength"
              type="number"
              placeholder="Er≈ëss√©g 1-10"
              min="1"
              max="10"
            />
            <button id="addCountryBtn" onclick="handleCountrySubmit()">
              Hozz√°ad√°s
            </button>
            <ul id="countriesList"></ul>
          </div>

          <div class="box">
            <h2>Csapatok</h2>
            <div id="teamWheelContainer" class="wheel-container">
              <div class="pointer">‚óÑ</div>
              <canvas id="teamWheel" width="250" height="250"></canvas>
            </div>
            <button id="spinTeamBtn">Csapat oszt√°s / Forgat√°s</button>
            <h3>
              Csapat 1 j√°t√©kosok
              <span class="count-display" id="team1PlayerCount">(0)</span>
            </h3>
            <ul id="playerBasket1" class="player-basket"></ul>
            <h3>
              Csapat 2 j√°t√©kosok
              <span class="count-display" id="team2PlayerCount">(0)</span>
            </h3>
            <ul id="playerBasket2" class="player-basket"></ul>
          </div>

          <div class="box">
            <h2>
              Orsz√°gok <span class="count-display" id="countryBoxCount">(0)</span>
            </h2>
            <div id="countryWheelContainer" class="wheel-container">
              <div class="pointer">‚óÑ</div>
              <canvas id="countryWheel" width="250" height="250"></canvas>
            </div>
            <button id="spinCountryBtn">Orsz√°g oszt√°s / Forgat√°s</button>

            <div id="countryGridsContainer">
              <div class="team-grid-wrapper" id="team1CountryGridWrapper">
                <h3>
                  Csapat 1 orsz√°gok
                  <span class="count-display" id="team1CountryCount">(0/9)</span>
                  <button
                    class="grid-zoom-btn"
                    data-targetwrapper="team1CountryGridWrapper"
                    title="Nagy√≠t√°s/Kicsiny√≠t√©s"
                  >
                    üîç
                  </button>
                </h3>
                <div id="countrySlots1" class="basket-grid"></div>
              </div>
              <div class="team-grid-wrapper" id="team2CountryGridWrapper">
                <h3>
                  Csapat 2 orsz√°gok
                  <span class="count-display" id="team2CountryCount">(0/9)</span>
                  <button
                    class="grid-zoom-btn"
                    data-targetwrapper="team2CountryGridWrapper"
                    title="Nagy√≠t√°s/Kicsiny√≠t√©s"
                  >
                    üîç
                  </button>
                </h3>
                <div id="countrySlots2" class="basket-grid"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Szavaz√°s -->
      <section id="szavazas">
        <h2>Szavaz√°sok</h2>
        <div id="pollCreator" class="poll-card">
          <h3>√öj szavaz√°s l√©trehoz√°sa</h3>
          <p id="pollCreatorNotice" class="poll-hint"></p>
          <form id="createPollForm">
            <input
              id="questionInput"
              class="poll-text-input"
              type="text"
              placeholder="K√©rd√©s"
              required
            />
            <div id="optionsContainer" class="poll-options-inputs"></div>
            <div class="poll-creator-actions">
              <button type="button" id="addOptionBtn" class="poll-button poll-secondary-btn">
                √öj v√°laszlehet≈ës√©g
              </button>
              <button type="submit" class="poll-button poll-primary-btn">
                Szavaz√°s l√©trehoz√°sa
              </button>
            </div>
          </form>
        </div>
        <div id="pollList" class="poll-list"></div>
      </section>

<!-- Programok -->
      <section id="programok">
        <div class="flex program-grid">
          <div class="box">
            <img src="program_icons/foto-apparatus.png" alt="FOTO-Appar√°tus ikon" class="program-icon" />
            <h3>FOTO-Appar√°tus</h3>
            <p>Lefot√≥zza a fitym√°dat bizonyos id≈ëk√∂z√∂nk√©nt</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 2</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 3</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
          <div class="box">
            <img src="program_icons/placeholder.png" alt="Program ikon" class="program-icon" />
            <h3>Program 4</h3>
            <p>Hamarosan...</p>
            <button class="download-btn" disabled>Let√∂lt√©s</button>
          </div>
        </div>
      </section>

      <section id="admin">
        <h2>Felhaszn√°l√≥k Kezel√©se</h2>
        <p class="admin-description">
          √Åll√≠tsd be felhaszn√°l√≥nk√©nt, hogy ki t√∂lthet fel, valamint a felt√∂lt√©sekhez tartoz√≥ m√©ret- √©s darabkorl√°tokat.
        </p>
        <div id="userListContainer"></div>
        <button id="savePermissionsBtn">V√°ltoztat√°sok Ment√©se</button>
      </section>
    </main>

    <footer>
      <p>¬© 2025 UMGKL HUB</p>
    </footer>

    <script>
      const videoGridContainer = document.getElementById("video-grid-container");
      const showUploadModalBtn = document.getElementById("showUploadModalBtn");
      const uploadModal = document.getElementById("uploadModal");
      const closeUploadModalBtn = document.getElementById("closeUploadModal");
      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("fileInput");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadStatus = document.getElementById("uploadStatus");
      const selectedFileName = document.getElementById("selectedFileName");
      let selectedVideoFile = null;

      async function loadVideos() {
        if (!videoGridContainer) {
          return;
        }

        videoGridContainer.innerHTML = "";

        try {
          const response = await fetch("/api/videos");

          if (!response.ok) {
            throw new Error("Nem siker√ºlt bet√∂lteni a vide√≥kat.");
          }

          const videos = await response.json();

          if (!Array.isArray(videos) || videos.length === 0) {
            videoGridContainer.innerHTML = "<p>M√©g senki nem t√∂lt√∂tt fel vide√≥t.</p>";
            return;
          }

          videos.forEach((video) => {
            const card = document.createElement("div");
            card.className = "video-card";

            const videoElement = document.createElement("video");
            videoElement.src = `/uploads/${video.filename}`;
            videoElement.controls = true;
            videoElement.preload = "metadata";

            const uploader = document.createElement("p");
            uploader.textContent = `Felt√∂lt√∂tte: ${video.username || "Ismeretlen"}`;

            card.appendChild(videoElement);
            card.appendChild(uploader);

            videoGridContainer.appendChild(card);
          });
        } catch (error) {
          console.error("Vide√≥k bet√∂lt√©si hib√°ja:", error);
          videoGridContainer.innerHTML = "<p>Nem siker√ºlt bet√∂lteni a vide√≥kat.</p>";
        }
      }

      function resetUploadModal() {
        selectedVideoFile = null;
        if (uploadBtn) {
          uploadBtn.disabled = true;
        }
        if (uploadStatus) {
          uploadStatus.textContent = "";
        }
        if (selectedFileName) {
          selectedFileName.textContent = "Nincs kiv√°lasztott f√°jl.";
        }
        if (fileInput) {
          fileInput.value = "";
        }
        if (dropZone) {
          dropZone.classList.remove("drag-over");
        }
      }

      function openUploadModal() {
        if (uploadModal) {
          uploadModal.style.display = "flex";
        }
        resetUploadModal();
      }

      function closeUploadModal() {
        if (uploadModal) {
          uploadModal.style.display = "none";
        }
        resetUploadModal();
      }

      function handleFileSelection(file) {
        if (!file) {
          return;
        }
        selectedVideoFile = file;
        if (selectedFileName) {
          selectedFileName.textContent = `Kiv√°lasztott f√°jl: ${file.name}`;
        }
        if (uploadBtn) {
          uploadBtn.disabled = false;
        }
        if (uploadStatus) {
          uploadStatus.textContent = "";
        }
      }

      if (showUploadModalBtn && uploadModal) {
        showUploadModalBtn.addEventListener("click", () => {
          const token = localStorage.getItem("token");
          if (!token) {
            alert("A felt√∂lt√©shez be kell jelentkezned.");
            return;
          }
          openUploadModal();
        });
      }

      if (closeUploadModalBtn) {
        closeUploadModalBtn.addEventListener("click", closeUploadModal);
      }

      if (uploadModal) {
        uploadModal.addEventListener("click", (event) => {
          if (event.target === uploadModal) {
            closeUploadModal();
          }
        });
      }

      if (dropZone && fileInput) {
        dropZone.addEventListener("click", () => fileInput.click());

        dropZone.addEventListener("dragover", (event) => {
          event.preventDefault();
          dropZone.classList.add("drag-over");
        });

        ["dragleave", "dragend"].forEach((eventName) => {
          dropZone.addEventListener(eventName, (event) => {
            event.preventDefault();
            dropZone.classList.remove("drag-over");
          });
        });

        dropZone.addEventListener("drop", (event) => {
          event.preventDefault();
          dropZone.classList.remove("drag-over");
          const files = event.dataTransfer?.files;
          if (files && files.length > 0) {
            handleFileSelection(files[0]);
          }
        });
      }

      if (fileInput) {
        fileInput.addEventListener("change", (event) => {
          const files = event.target.files;
          if (files && files.length > 0) {
            handleFileSelection(files[0]);
          } else {
            resetUploadModal();
          }
        });
      }

      if (uploadBtn) {
        uploadBtn.addEventListener("click", async () => {
          const token = localStorage.getItem("token");
          if (!token) {
            alert("A felt√∂lt√©shez be kell jelentkezned.");
            return;
          }

          if (!selectedVideoFile) {
            alert("V√°lassz ki egy vide√≥f√°jlt a felt√∂lt√©shez.");
            return;
          }

          const formData = new FormData();
          formData.append("video", selectedVideoFile);

          uploadBtn.disabled = true;
          if (uploadStatus) {
            uploadStatus.textContent = "Felt√∂lt√©s folyamatban...";
          }

          try {
            const response = await fetch("/upload", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: formData,
            });

            const result = await response.json().catch(() => null);

            if (!response.ok) {
              const message = (result && result.message) || "Nem siker√ºlt felt√∂lteni a vide√≥t.";
              throw new Error(message);
            }

            if (uploadStatus) {
              uploadStatus.textContent = (result && result.message) || "Vide√≥ sikeresen felt√∂ltve.";
            }
            await loadVideos();
            setTimeout(() => {
              closeUploadModal();
            }, 800);
          } catch (error) {
            console.error("Vide√≥ felt√∂lt√©si hiba:", error);
            if (uploadStatus) {
              uploadStatus.textContent = error.message || "Nem siker√ºlt felt√∂lteni a vide√≥t.";
            }
          } finally {
            if (uploadBtn) {
              uploadBtn.disabled = false;
            }
          }
        });
      }

      function showSection(target, shouldPushState = true) {
        const navLinks = Array.from(document.querySelectorAll("nav a"));
        const sections = document.querySelectorAll("main section");
        const hasMatch = navLinks.some((link) => link.dataset.section === target);

        if (!hasMatch) {
          target = "home";
        }

        navLinks.forEach((link) => {
          link.classList.toggle("active", link.dataset.section === target);
        });

        sections.forEach((sec) => {
          if (sec.id === target) {
            sec.classList.add("active");
          } else {
            sec.classList.remove("active");
          }
        });

        if (target === "klipek") {
          loadVideos();
        }

        if (shouldPushState) {
          history.pushState(null, "", `#${target}`);
        }
      }

      document.querySelectorAll("nav a").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          showSection(link.dataset.section);
        });
      });

      // Oldal bet√∂lt√©sekor a hash alapj√°n nyitjuk meg a megfelel≈ë szekci√≥t
      window.addEventListener("load", () => {
        const hash = location.hash.replace("#", "") || "home";
        showSection(hash, false);
      });
    </script>

  <script>
    const loginModal = document.getElementById("loginModal");
    const closeLogin = document.getElementById("closeLogin");
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authLoggedOut = document.getElementById("authLoggedOut");
    const authLoggedIn = document.getElementById("authLoggedIn");
    const userGreeting = document.getElementById("userGreeting");
    const adminNavBtn = document.getElementById("adminNavBtn");
    const userListContainer = document.getElementById("userListContainer");
    const savePermissionsBtn = document.getElementById("savePermissionsBtn");
    const pollCreator = document.getElementById("pollCreator");
    const pollCreatorNotice = document.getElementById("pollCreatorNotice");
    const createPollForm = document.getElementById("createPollForm");
    const questionInput = document.getElementById("questionInput");
    const optionsContainer = document.getElementById("optionsContainer");
    const addOptionBtn = document.getElementById("addOptionBtn");
    const pollListContainer = document.getElementById("pollList");

    const SESSION_KEYS = {
      token: "token",
      username: "username",
      isAdmin: "isAdmin",
    };
    const POLL_MIN_OPTIONS = 2;

    function storeSessionData({ token, username, isAdmin }) {
      if (typeof token === "string" && token.trim()) {
        localStorage.setItem(SESSION_KEYS.token, token);
      }
      if (typeof username === "string" && username.trim()) {
        localStorage.setItem(SESSION_KEYS.username, username);
      }
      localStorage.setItem(SESSION_KEYS.isAdmin, isAdmin ? "true" : "false");
    }

    function clearStoredSession() {
      localStorage.removeItem(SESSION_KEYS.token);
      localStorage.removeItem(SESSION_KEYS.username);
      localStorage.removeItem(SESSION_KEYS.isAdmin);
    }

    function getStoredToken() {
      return localStorage.getItem(SESSION_KEYS.token) || "";
    }

    function isUserLoggedIn() {
      return !!getStoredToken();
    }

    function buildAuthHeaders() {
      const token = getStoredToken();
      return token ? { Authorization: `Bearer ${token}` } : {};
    }

    if (savePermissionsBtn) {
      savePermissionsBtn.disabled = true;
    }

    function openLoginModal() {
      if (loginForm) {
        loginForm.reset();
      }
      loginModal.style.display = "flex";
    }

    function createOptionRow(value = "") {
      const row = document.createElement("div");
      row.className = "poll-option-row";

      const input = document.createElement("input");
      input.type = "text";
      input.className = "poll-option-input";
      input.placeholder = "V√°laszlehet≈ës√©g";
      input.required = true;
      input.value = value;

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "poll-option-remove";
      removeBtn.setAttribute("aria-label", "V√°laszlehet≈ës√©g t√∂rl√©se");
      removeBtn.textContent = "‚úï";
      removeBtn.addEventListener("click", () => {
        if (!optionsContainer) {
          return;
        }
        row.remove();
        ensureMinimumOptionRows();
        updateOptionRemoveButtons();
      });

      row.appendChild(input);
      row.appendChild(removeBtn);

      return row;
    }

    function updateOptionRemoveButtons() {
      if (!optionsContainer) {
        return;
      }

      const rows = optionsContainer.querySelectorAll(".poll-option-row");
      rows.forEach((row) => {
        const removeBtn = row.querySelector(".poll-option-remove");
        if (removeBtn) {
          removeBtn.disabled = rows.length <= POLL_MIN_OPTIONS;
        }
      });
    }

    function addOptionRow(value = "") {
      if (!optionsContainer) {
        return null;
      }

      const row = createOptionRow(value);
      optionsContainer.appendChild(row);
      updateOptionRemoveButtons();
      return row;
    }

    function ensureMinimumOptionRows() {
      if (!optionsContainer) {
        return;
      }

      const currentRows = optionsContainer.querySelectorAll(".poll-option-row").length;
      const missing = POLL_MIN_OPTIONS - currentRows;

      if (missing > 0) {
        for (let i = 0; i < missing; i += 1) {
          addOptionRow();
        }
      }

      updateOptionRemoveButtons();
    }

    function resetPollForm() {
      if (createPollForm) {
        createPollForm.reset();
      }

      if (optionsContainer) {
        optionsContainer.innerHTML = "";
      }

      ensureMinimumOptionRows();
    }

    function updatePollCreatorState(forceLoggedInState) {
      if (!pollCreator || !createPollForm) {
        return;
      }

      const loggedIn =
        typeof forceLoggedInState === "boolean" ? forceLoggedInState : isUserLoggedIn();

      if (loggedIn) {
        createPollForm.style.display = "block";
        if (pollCreatorNotice) {
          pollCreatorNotice.textContent =
            "Adj meg egy k√©rd√©st √©s legal√°bb k√©t v√°laszlehet≈ës√©get.";
        }
        ensureMinimumOptionRows();
      } else {
        createPollForm.style.display = "none";
        if (pollCreatorNotice) {
          pollCreatorNotice.textContent =
            "Szavaz√°st l√©trehozni csak bejelentkezett felhaszn√°l√≥k tudnak.";
        }
      }
    }

    function renderPoll(poll) {
      const card = document.createElement("div");
      card.className = "poll-card";

      const header = document.createElement("div");
      header.className = "poll-card-header";

      const title = document.createElement("h3");
      title.textContent = poll?.question || "Szavaz√°s";
      header.appendChild(title);

      const status = document.createElement("span");
      status.className = `poll-status ${poll?.isActive ? "poll-status--active" : "poll-status--closed"}`;
      status.textContent = poll?.isActive ? "Akt√≠v" : "Lez√°rt";
      header.appendChild(status);

      card.appendChild(header);

      const creatorName = poll?.creator?.username || "Ismeretlen";
      const meta = document.createElement("div");
      meta.className = "poll-meta";
      let metaText = `L√©trehozta: ${creatorName}`;
      if (poll?.createdAt) {
        const createdAt = new Date(poll.createdAt);
        if (!Number.isNaN(createdAt.valueOf())) {
          metaText += ` ‚Ä¢ ${createdAt.toLocaleString("hu-HU")}`;
        }
      }
      meta.textContent = metaText;
      card.appendChild(meta);

      if (poll?.isActive && !isUserLoggedIn()) {
        const notice = document.createElement("div");
        notice.className = "poll-hint";
        notice.textContent = "Szavazni csak bejelentkezett felhaszn√°l√≥k tudnak.";
        card.appendChild(notice);
      }

      const optionsWrapper = document.createElement("div");
      optionsWrapper.className = "poll-options-results";

      const totalVotes = Number(poll?.totalVotes) || 0;

      if (Array.isArray(poll?.options)) {
        poll.options.forEach((option) => {
          const optionResult = document.createElement("div");
          optionResult.className = "poll-option-result";
          if (poll?.userVoteOptionId === option.id) {
            optionResult.classList.add("poll-option-result--selected");
          }

          const headerRow = document.createElement("div");
          headerRow.className = "poll-option-header";

          const label = document.createElement("div");
          label.className = "poll-option-label";
          label.textContent = option?.text || "V√°laszlehet≈ës√©g";
          headerRow.appendChild(label);

          const count = document.createElement("div");
          count.className = "poll-option-count";
          const votes = Number(option?.voteCount) || 0;
          const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
          count.textContent = `${votes} szavazat (${percentage}%)`;
          headerRow.appendChild(count);

          if (poll?.isActive && !poll?.userVoteOptionId && isUserLoggedIn()) {
            const voteBtn = document.createElement("button");
            voteBtn.type = "button";
            voteBtn.className = "poll-button poll-vote-btn";
            voteBtn.textContent = "Szavazok";
            voteBtn.addEventListener("click", () => handlePollVote(poll.id, option.id, voteBtn));
            headerRow.appendChild(voteBtn);
          } else if (poll?.userVoteOptionId === option.id) {
            const badge = document.createElement("span");
            badge.className = "poll-badge";
            badge.textContent = "Szavazatod";
            headerRow.appendChild(badge);
          }

          optionResult.appendChild(headerRow);

          const bar = document.createElement("div");
          bar.className = "poll-result-bar";
          const fill = document.createElement("div");
          fill.className = "poll-result-bar-fill";
          const fillWidth = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
          fill.style.width = `${fillWidth}%`;
          bar.appendChild(fill);
          optionResult.appendChild(bar);

          const votersElement = document.createElement("div");
          votersElement.className = "poll-voters";
          if (Array.isArray(option?.voters) && option.voters.length > 0) {
            const names = option.voters
              .map((voter) => voter?.username || `#${voter?.id ?? "?"}`)
              .join(", ");
            votersElement.textContent = `Szavaztak: ${names}`;
          } else {
            votersElement.textContent = "M√©g nincs szavazat.";
          }
          optionResult.appendChild(votersElement);

          optionsWrapper.appendChild(optionResult);
        });
      }

      card.appendChild(optionsWrapper);

      const totalVotesInfo = document.createElement("div");
      totalVotesInfo.className = "poll-total-votes";
      totalVotesInfo.textContent = `√ñsszes szavazat: ${totalVotes}`;
      card.appendChild(totalVotesInfo);

      if (poll?.canClose) {
        const actions = document.createElement("div");
        actions.className = "poll-actions";
        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.className = "poll-button poll-close-btn";
        closeBtn.textContent = "Szavaz√°s lez√°r√°sa";
        closeBtn.addEventListener("click", () => handleClosePoll(poll.id, closeBtn));
        actions.appendChild(closeBtn);
        card.appendChild(actions);
      }

      return card;
    }

    async function loadPolls() {
      if (!pollListContainer) {
        return;
      }

      pollListContainer.innerHTML = "";
      const loadingElement = document.createElement("div");
      loadingElement.className = "poll-empty";
      loadingElement.textContent = "Szavaz√°sok bet√∂lt√©se...";
      pollListContainer.appendChild(loadingElement);

      try {
        const response = await fetch("/api/polls", { headers: buildAuthHeaders() });

        if (!response.ok) {
          throw new Error("Nem siker√ºlt bet√∂lteni a szavaz√°sokat.");
        }

        const polls = await response.json();
        pollListContainer.innerHTML = "";

        if (!Array.isArray(polls) || polls.length === 0) {
          const emptyElement = document.createElement("div");
          emptyElement.className = "poll-empty";
          emptyElement.textContent = "Jelenleg nincs akt√≠v szavaz√°s.";
          pollListContainer.appendChild(emptyElement);
          return;
        }

        polls.forEach((poll) => {
          pollListContainer.appendChild(renderPoll(poll));
        });
      } catch (error) {
        console.error("Szavaz√°sok bet√∂lt√©si hiba:", error);
        pollListContainer.innerHTML = "";
        const errorElement = document.createElement("div");
        errorElement.className = "poll-empty";
        errorElement.textContent = "Nem siker√ºlt bet√∂lteni a szavaz√°sokat.";
        pollListContainer.appendChild(errorElement);
      }
    }

    async function handlePollVote(pollId, optionId, button) {
      if (!isUserLoggedIn()) {
        alert("Szavaz√°shoz be kell jelentkezned.");
        if (typeof openLoginModal === "function") {
          openLoginModal();
        }
        return;
      }

      const originalText = button ? button.textContent : "";
      if (button) {
        button.disabled = true;
        button.textContent = "K√ºld√©s...";
      }

      try {
        const response = await fetch(`/api/polls/${pollId}/vote`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...buildAuthHeaders(),
          },
          body: JSON.stringify({ optionId }),
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message =
            payload && payload.message
              ? payload.message
              : "Nem siker√ºlt r√∂gz√≠teni a szavazatot.";
          throw new Error(message);
        }

        await loadPolls();
      } catch (error) {
        console.error("Szavazat ment√©si hiba:", error);
        alert(error.message || "Nem siker√ºlt r√∂gz√≠teni a szavazatot.");
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = originalText || "Szavazok";
        }
      }
    }

    async function handleClosePoll(pollId, button) {
      if (!isUserLoggedIn()) {
        alert("A szavaz√°s lez√°r√°s√°hoz be kell jelentkezned.");
        if (typeof openLoginModal === "function") {
          openLoginModal();
        }
        return;
      }

      if (!confirm("Biztosan lez√°rod a szavaz√°st?")) {
        return;
      }

      const originalText = button ? button.textContent : "";
      if (button) {
        button.disabled = true;
        button.textContent = "Lez√°r√°s...";
      }

      try {
        const response = await fetch(`/api/polls/${pollId}/close`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...buildAuthHeaders(),
          },
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message =
            payload && payload.message
              ? payload.message
              : "Nem siker√ºlt lez√°rni a szavaz√°st.";
          throw new Error(message);
        }

        await loadPolls();
      } catch (error) {
        console.error("Szavaz√°s lez√°r√°si hiba:", error);
        alert(error.message || "Nem siker√ºlt lez√°rni a szavaz√°st.");
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = originalText || "Szavaz√°s lez√°r√°sa";
        }
      }
    }

    if (addOptionBtn) {
      addOptionBtn.addEventListener("click", () => {
        if (!isUserLoggedIn()) {
          alert("Szavaz√°st l√©trehozni csak bejelentkezve tudsz.");
          if (typeof openLoginModal === "function") {
            openLoginModal();
          }
          return;
        }

        addOptionRow();
      });
    }

    if (createPollForm) {
      createPollForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        if (!isUserLoggedIn()) {
          alert("Szavaz√°st l√©trehozni csak bejelentkezve tudsz.");
          if (typeof openLoginModal === "function") {
            openLoginModal();
          }
          return;
        }

        const question = questionInput ? questionInput.value.trim() : "";
        const optionInputs = optionsContainer
          ? Array.from(optionsContainer.querySelectorAll(".poll-option-input"))
          : [];
        const optionValues = optionInputs.map((input) => input.value.trim()).filter(Boolean);

        const uniqueOptions = [];
        const seenOptions = new Set();
        optionValues.forEach((option) => {
          const key = option.toLowerCase();
          if (!seenOptions.has(key)) {
            seenOptions.add(key);
            uniqueOptions.push(option);
          }
        });

        if (!question || uniqueOptions.length < POLL_MIN_OPTIONS) {
          alert("Adj meg egy k√©rd√©st √©s legal√°bb k√©t k√ºl√∂nb√∂z≈ë v√°laszlehet≈ës√©get!");
          return;
        }

        const submitButton = createPollForm.querySelector('button[type="submit"]');
        const originalText = submitButton ? submitButton.textContent : "";

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "L√©trehoz√°s...";
        }

        try {
          const response = await fetch("/api/polls", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...buildAuthHeaders(),
            },
            body: JSON.stringify({ question, options: uniqueOptions }),
          });

          const payload = await response.json().catch(() => ({}));

          if (!response.ok) {
            const message =
              payload && payload.message
                ? payload.message
                : "Nem siker√ºlt l√©trehozni a szavaz√°st.";
            throw new Error(message);
          }

          resetPollForm();
          updatePollCreatorState(true);
          await loadPolls();
        } catch (error) {
          console.error("Szavaz√°s l√©trehoz√°si hiba:", error);
          alert(error.message || "Nem siker√ºlt l√©trehozni a szavaz√°st.");
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = originalText || "Szavaz√°s l√©trehoz√°sa";
          }
        }
      });
    }

    ensureMinimumOptionRows();
    updatePollCreatorState();
    loadPolls();

    function updateAdminNavVisibility() {
      if (!adminNavBtn) return;

      const isAdmin = localStorage.getItem(SESSION_KEYS.isAdmin) === "true";
      adminNavBtn.style.display = isAdmin ? "inline-block" : "none";

      if (!isAdmin) {
        const adminSection = document.getElementById("admin");
        if (adminSection && adminSection.classList.contains("active")) {
          const homeLink = document.querySelector('nav a[data-section="home"]');
          if (homeLink) {
            homeLink.click();
          } else {
            adminSection.classList.remove("active");
          }
        }
        if (userListContainer) {
          userListContainer.innerHTML = "";
        }
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
      }
    }

    function updateUIForLoggedIn(username) {
      if (userGreeting) {
        userGreeting.textContent = `Szia, ${username}!`;
      }
      if (authLoggedOut) {
        authLoggedOut.style.display = "none";
      }
      if (authLoggedIn) {
        authLoggedIn.style.display = "flex";
      }

      updateAdminNavVisibility();
      updatePollCreatorState(true);
      loadPolls();
    }

    function updateUIForLoggedOut() {
      if (authLoggedOut) {
        authLoggedOut.style.display = "flex";
      }
      if (authLoggedIn) {
        authLoggedIn.style.display = "none";
      }
      if (userGreeting) {
        userGreeting.textContent = "";
      }
      updateAdminNavVisibility();
      updatePollCreatorState(false);
      loadPolls();
    }

    if (loginBtn) {
      loginBtn.addEventListener("click", openLoginModal);
    }

    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        clearStoredSession();
        updateUIForLoggedOut();
        try {
          await fetch("/logout", { method: "POST" });
        } catch (error) {
          console.warn("Nem siker√ºlt kijelentkeztetni a szerveren:", error);
        }
        alert("Sikeresen kijelentkezt√©l.");
      });
    }

    function renderUserList(users) {
      if (!userListContainer) {
        return;
      }

      userListContainer.innerHTML = "";

      if (!Array.isArray(users) || users.length === 0) {
        userListContainer.textContent = "Nincs megjelen√≠thet≈ë felhaszn√°l√≥.";
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
        return;
      }

      const table = document.createElement("table");
      table.className = "user-table";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Felhaszn√°l√≥n√©v</th>
          <th>Felt√∂lt√©si jogosults√°g</th>
          <th>Max f√°jlm√©ret (MB)</th>
          <th>Vide√≥ limit</th>
          <th>Felt√∂lt√∂tt vide√≥k</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      users.forEach((user) => {
        const row = document.createElement("tr");
        row.dataset.userId = user.id;

        const usernameCell = document.createElement("td");
        usernameCell.textContent = user.username;
        row.appendChild(usernameCell);

        const permissionCell = document.createElement("td");
        const label = document.createElement("label");
        label.className = "permission-toggle";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = Number(user.can_upload) === 1;
        label.appendChild(checkbox);
        label.append(" Felt√∂lthet");
        permissionCell.appendChild(label);
        row.appendChild(permissionCell);

        const maxFileSizeCell = document.createElement("td");
        const maxFileInput = document.createElement("input");
        maxFileInput.type = "number";
        maxFileInput.min = "1";
        maxFileInput.required = true;
        maxFileInput.name = "maxFileSizeMb";
        maxFileInput.value = Number.parseInt(user.max_file_size_mb, 10) || "";
        maxFileSizeCell.appendChild(maxFileInput);
        row.appendChild(maxFileSizeCell);

        const maxVideosCell = document.createElement("td");
        const maxVideosInput = document.createElement("input");
        maxVideosInput.type = "number";
        maxVideosInput.min = "1";
        maxVideosInput.required = true;
        maxVideosInput.name = "maxVideos";
        maxVideosInput.value = Number.parseInt(user.max_videos, 10) || "";
        maxVideosCell.appendChild(maxVideosInput);
        row.appendChild(maxVideosCell);

        const uploadsCell = document.createElement("td");
        uploadsCell.textContent = Number.parseInt(user.upload_count, 10) || 0;
        row.appendChild(uploadsCell);

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      userListContainer.appendChild(table);

      if (savePermissionsBtn) {
        savePermissionsBtn.disabled = false;
      }
    }

    async function loadAdminPanel() {
      const storedToken = localStorage.getItem("token");
      const token = typeof storedToken === "string" ? storedToken.trim() : null;

      if (!token) {
        alert("Nincs √©rv√©nyes hiteles√≠t√©s.");
        return;
      }

      try {
        const response = await fetch("/api/users", {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json().catch(() => null);

        if (!response.ok) {
          const message = data && data.message ? data.message : "Nem siker√ºlt bet√∂lteni a felhaszn√°l√≥kat.";
          throw new Error(message);
        }

        renderUserList(Array.isArray(data) ? data : []);
      } catch (error) {
        console.error("Admin panel bet√∂lt√©si hiba:", error);
        alert(error.message || "Nem siker√ºlt bet√∂lteni az admin panel adatait.");
        if (savePermissionsBtn) {
          savePermissionsBtn.disabled = true;
        }
      }
    }

    if (savePermissionsBtn) {
      const originalButtonText = savePermissionsBtn.textContent;

      savePermissionsBtn.addEventListener("click", async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Nincs √©rv√©nyes hiteles√≠t√©s.");
          return;
        }

        if (!userListContainer) {
          alert("Nem tal√°lhat√≥ a felhaszn√°l√≥i lista.");
          return;
        }

        const tableBody = userListContainer.querySelector("tbody");
        if (!tableBody) {
          alert("Nincs ment√©sre v√°r√≥ adat.");
          return;
        }

        const rows = Array.from(tableBody.querySelectorAll("tr"));
        const invalidEntries = [];
        const permissionsToUpdate = rows
          .map((row) => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            const maxFileSizeInput = row.querySelector('input[name="maxFileSizeMb"]');
            const maxVideosInput = row.querySelector('input[name="maxVideos"]');
            const userIdAttr = row.dataset.userId;

            if (!checkbox || !maxFileSizeInput || !maxVideosInput || !userIdAttr) {
              return null;
            }

            const userId = Number.parseInt(userIdAttr, 10);
            if (Number.isNaN(userId)) {
              return null;
            }

            const maxFileSizeValue = Number.parseInt(maxFileSizeInput.value, 10);
            const maxVideosValue = Number.parseInt(maxVideosInput.value, 10);

            if (!Number.isFinite(maxFileSizeValue) || maxFileSizeValue <= 0 || !Number.isFinite(maxVideosValue) || maxVideosValue <= 0) {
              const usernameCell = row.querySelector("td");
              const identifier = usernameCell ? usernameCell.textContent.trim() : `ID ${userId}`;
              invalidEntries.push(identifier);
              return null;
            }

            return {
              userId,
              canUpload: checkbox.checked,
              maxFileSizeMb: maxFileSizeValue,
              maxVideos: maxVideosValue,
            };
          })
          .filter(Boolean);

        if (invalidEntries.length > 0) {
          alert(`Adj meg √©rv√©nyes, pozit√≠v limiteket a k√∂vetkez≈ë felhaszn√°l√≥kn√°l: ${invalidEntries.join(", ")}.`);
          return;
        }

        if (permissionsToUpdate.length === 0) {
          alert("Nincs ment√©sre v√°r√≥ adat.");
          return;
        }

        savePermissionsBtn.disabled = true;
        savePermissionsBtn.textContent = "Ment√©s folyamatban...";

        try {
          const response = await fetch("/api/users/permissions/batch-update", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(permissionsToUpdate),
          });

          const result = await response.json().catch(() => null);

          if (!response.ok) {
            const message = result && result.message ? result.message : "Nem siker√ºlt menteni a jogosults√°gokat.";
            throw new Error(message);
          }

          alert((result && result.message) || "Jogosults√°gok sikeresen friss√≠tve.");
          await loadAdminPanel();
        } catch (error) {
          console.error("Jogosults√°g ment√©si hiba:", error);
          alert(error.message || "Nem siker√ºlt menteni a jogosults√°gokat.");
        } finally {
          savePermissionsBtn.disabled = false;
          savePermissionsBtn.textContent = originalButtonText;
        }
      });
    }

    closeLogin.addEventListener("click", () => {
      loginModal.style.display = "none";
    });

    if (adminNavBtn) {
      adminNavBtn.addEventListener("click", loadAdminPanel);
    }

    const loginSuccessModal = document.getElementById("loginSuccessModal");
    const loginSuccessMessage = document.getElementById("loginSuccessMessage");
    const loginSuccessClose = document.getElementById("loginSuccessClose");
    const loginSuccessOk = document.getElementById("loginSuccessOk");

    const hideLoginSuccessModal = () => {
      loginSuccessModal.style.display = "none";
      loginSuccessMessage.textContent = "";
    };

    const showLoginSuccessModal = (message) => {
      loginSuccessMessage.textContent = message;
      loginSuccessModal.style.display = "flex";
      loginSuccessOk.focus();
    };

    loginSuccessClose.addEventListener("click", hideLoginSuccessModal);
    loginSuccessOk.addEventListener("click", hideLoginSuccessModal);
    loginSuccessModal.addEventListener("click", (event) => {
      if (event.target === loginSuccessModal) {
        hideLoginSuccessModal();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && loginSuccessModal.style.display === "flex") {
        hideLoginSuccessModal();
      }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("loginUser").value;
      const password = document.getElementById("loginPass").value;

      try {
        const res = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const data = await res.json();

        if (res.ok) {
          storeSessionData({
            token: data.token,
            username: data.username,
            isAdmin: !!data.isAdmin,
          });
          updateUIForLoggedIn(data.username);
          loginModal.style.display = "none";
          showLoginSuccessModal(data.message || "Sikeres bejelentkez√©s.");
        } else {
          alert(data.message || "Hib√°s felhaszn√°l√≥n√©v vagy jelsz√≥.");
        }
      } catch (error) {
        console.error("Bejelentkez√©si hiba:", error);
        alert("Hiba t√∂rt√©nt a bejelentkez√©s sor√°n. Pr√≥b√°ld meg k√©s≈ëbb.");
      }
    });

    async function ensureSessionOnLoad() {
      const storedToken = localStorage.getItem(SESSION_KEYS.token);
      const headers = {};

      if (storedToken) {
        headers.Authorization = `Bearer ${storedToken}`;
      }

      try {
        const response = await fetch("/auth/me", {
          method: "GET",
          headers,
        });

        if (!response.ok) {
          throw new Error("√ârv√©nytelen munkamenet");
        }

        const session = await response.json();

        if (!session || !session.token || !session.username) {
          throw new Error("Hi√°nyos munkamenet adatok");
        }

        storeSessionData({
          token: session.token,
          username: session.username,
          isAdmin: !!session.isAdmin,
        });

        updateUIForLoggedIn(session.username);

        if (adminNavBtn) {
          adminNavBtn.style.display = session.isAdmin ? "inline-block" : "none";
        }
      } catch (error) {
        console.warn("Nem siker√ºlt vissza√°ll√≠tani a munkamenetet:", error);
        clearStoredSession();
        updateUIForLoggedOut();
      }
    }

    window.addEventListener("load", () => {
      ensureSessionOnLoad();
    });
  </script>

  <script src="HOI4-Porgonc/script.js"></script>
  </body>
</html>
